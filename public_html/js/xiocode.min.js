/*! xiocode 2015-07-20 21:26:54 */
var XI = (function() {
	var debug = true;

	var actions = {},
	listeners = [],

	fire = function(action) {
		if(debug) console.log("Fire "+action);
		actions[action] = true;
		testAll(action);
	},

	reset = function(action) {
		delete actions[action];
	},

	testAll = function(firedAction) {
		var i = listeners.length;
		while(i--) {
			if(test(listeners[i],firedAction)) {
				if(debug) console.log("All actions fired for", listeners[i]);
				listeners[i].callback();
				if(!listeners[i].keep) {
					listeners.splice(i,1);
				}
			}
		}
	},

	listen = function(conditions, callback, keep) {
		if(!Array.isArray(conditions)) {
			conditions = [conditions];
		}
		var listener = {conditions:conditions, callback:callback, keep:keep};

		if(test(listener)) {
			listener.callback();
			return true;
		} else {
			listeners.push(listener);
			return listener;
		}
	},

	stopListen = function(listener) {
		var i=listeners.indexOf(listener);
		if(i !== -1) {
			listeners.splice(i,1);
		}
	},

	test = function(listener, firedAction) {
		var conds = listener.conditions;
		if(conds.indexOf(firedAction)===-1) return false

		var ready = true;
		for(var i=0; i<conds.length; i++) {
			var condition = conds[i];
			if(!actions.hasOwnProperty(condition)) {
				ready = false;
				break;
			}
		}
		return ready;
	};

	return {
		listen: listen,
		stopListen: stopListen,
		fire: fire,
		reset: reset
	}
}());
(function() {
	// PRIVATE VARIABLES
	var idNumber = 0;
	var files = {};
	var unsavedName = "untitled";
	var unsavedNumber = 1;

	// CONSTRUCTOR
	var _ = self.File = function(codeEditor) {
		this.id = idNumber++;
		this.uri = null;
		this.projectId = null;
		this.doc = null;
		this.state = _.STATE_EMPTY;
		this.filename = null;
		this.codeEditor = codeEditor;
		this.tab = null;
		files[this.id] = this;
	}

	// STATIC VARIABLES
	_.STATE_EMPTY = 0;
	_.STATE_LOADING = 20;
	_.STATE_READY = 30;
	_.STATE_SAVING = 40;
	_.STATE_DIRTY = 50;
	_.STATE_UNSAVED = 60;


	// PUBLIC METHODS
	_.prototype = {

		blank: function(projectId) {
			this.filename = unsavedName;// + "_" + unsavedNumber++;
			this.uri = this.filename;
			this.projectId = projectId;
			this.doc = CodeMirror.Doc("", "");
		},

		load: function(projectId, uri, callback) {
			this.state = _.STATE_LOADING;
			this.uri = uri;
			this.filename = getFilename(uri);
			this.projectId = projectId;
			this.doc = CodeMirror.Doc("", "");

			var parameters = {action:"load", project_id:projectId,	uri:encodeURI(uri)};
			Ajax.getJSON("/scripts/file_handler.php", parameters, loadCallback.bind(this, callback));
		},

		save: function(code, callback) {
			this.state = _.STATE_SAVING;
			var formData = new FormData();
			formData.append("uri", this.uri);
			formData.append("project_id", this.projectId);
			formData.append("code", code);
			formData.append("action", "save");
			console.log("Save file '"+ this.uri+"'...");
			Ajax.post2JSON("/scripts/file_handler.php", formData, saveCallback.bind(this, callback));
		},

		saveAs: function(newUri, code, overwrite, callback) {
			this.state = _.STATE_SAVING;
			var formData = new FormData();
			formData.append("uri", newUri);
			formData.append("project_id", this.projectId);
			formData.append("code", code);
			formData.append("action", "saveAs");
			if(overwrite) formData.append("overwrite", true);

			Ajax.post2JSON("/scripts/file_handler.php", formData, saveAsCallback.bind(this, callback));
		},

		close: function(force) {
			if(this.doc.isClean() || force) {
				this.codeEditor.closeFile(this);
				if(force) {
					this.doc.markClean();
					this.codeEditor.updateFileStatus(this);
				}
				delete files[this.id];
			} else {
				var me = this;
				XioPop.confirm({title:"Unsaved file", text:"This file has unsaved data, close anyway?", onSubmit:function(answer) {
					if(answer) me.close(true);
				}});
			}
		},

		rename: function(newUri) {
			this.uri = newUri;
			this.filename = getFilename(newUri);
			this.tab.updateFromFile();
		},

		setTab: function(tab) {
			this.tab = tab;
		}
	};


	// STATIC METHODS
	_.getFileById = function(id) {
		if(files.hasOwnProperty(id)) {
			return files[id];
		}
	};

	_.getFileByUri = function(projectId, uri) {
		for(var fileId in files) {
			if (files.hasOwnProperty(fileId)) {
				var file = files[fileId];
				if(file.projectId === projectId && file.uri === uri) {
					return file;
				}
			}
		}
	};

	_.getProjectFiles = function(projectId) {
		var projectFiles = {};
		for(var fileId in files) {
			if (files.hasOwnProperty(fileId)) {
				var file = files[fileId];
				if(file.projectId === projectId) {
					projectFiles[fileId] = file;
				}
			}
		}
		return projectFiles;
	};

	_.countDirtyFiles = function() {
		var counter=0;
		for(var fileId in files) {
			if (files.hasOwnProperty(fileId)) {
				var file = files[fileId];
				if(!file.doc.isClean()) {
					counter++;
				}
			}
		}
		return counter;
	};

	// PRIVATE METHODS
	var getFilename = function(uri) {
		return uri.replace(/^.*[\\\/]/, '');
	};

	var saveCallback = function(callback, response) {
		switch(response.status) {
			case STATUS_OK:
			this.doc.markClean();
			this.state = _.STATE_READY;
			if(callback) callback(this);
			break;

			case STATUS_FILE_COULD_NOT_UPDATE:
			XioPop.alert({title:"Permission denied", text:"You do not have sufficient permission to update the file"});
			this.state = _.STATE_DIRTY;
			break;

			default:
			XioPop.alert({title:"Error", text:"Unknown error while saving file"});
		}
	};

	var saveAsCallback = function(callback, response) {
		if(response.status === STATUS_OK) {
			this.doc.markClean();
			this.state = _.STATE_READY;
			this.uri = response.uri;
			this.filename = getFilename(response.uri);
			this.projectId = response.projectId;
		}

		if(callback) callback(this, response);
	};

	var loadCallback = function(callback, response) {
		if(response.status !== STATUS_OK) {
			console.warn("Error " + response.status + ": " + response.message);
			return;
		}

		this.doc = CodeMirror.Doc(response.text, getMimeByUri(response.uri));
		this.state = _.STATE_READY;

		if(callback) callback(this);
	}
}());
var FileList = (function() {
	"use strict";

	var projectId;
	var files;
	var fileList, rightClickMenu;
	var openedFolders = [];

	var init = function() {
		rightClickMenu = document.getElementById("fileListRightClickMenu");
		rightClickMenu.addEventListener("click", rightClickClickHandler, false);
		fileList = document.getElementById("fileList");
		fileList.addEventListener("drop", dropFile, false);
		fileList.addEventListener("dragover", hoverFile, false);
		fileList.addEventListener("dragleave", hoverFile, false);
		fileList.addEventListener("dragstart", dragFile, false);
		fileList.addEventListener("contextmenu", clickHandler, false);
		fileList.addEventListener("click", clickHandler, false);
		fileList.addEventListener("dblclick", clickHandler, false);
	};


	var setProjectId = function(newProjectId) {
		if(!fileList) init();

		projectId = newProjectId;
		console.debug("FileList: ProjectId set to " + newProjectId);

		loadProjectFiles();
	};


	var loadProjectFiles = function() {
		Ajax.getJSON("/scripts/get_project_files.php", {project_id: projectId},
			function(items) {
				files = {};

				fileList.innerHTML = printFolder(items, "");

				for(var i=0; i<openedFolders.length; i++) {
					var li = fileList.querySelector("li[data-uri='"+openedFolders[i]+"']");
					if(li) {
						openFolder(li);
					}
				}
			}, function(e) {
				if(e.status===403) {
					console.log("Access denied. You must login again to load the files");
					showLogin();
				}
				console.error("Error loading file tree", e);
			}
		);
	};

	var printFolder = function(arr, path) {
		var htm = [];
		htm.push("<ul>");
		for(var i=0; i<arr.length; i++) {
			var item = arr[i];
			var title = item.filename + "\n";
			var imagePreview="";
			if(item.type==="jpg" || item.type==="jpeg" || item.type==="gif" || item.type==="png" || item.type==="bmp" || item.type==="tif" || item.type==="tiff") {
				imagePreview=" imagePreview";
				title += item.width + " x " + item.height + "\n";
			}
			var uri = item.path + item.filename;
			files[uri] = item;

			var changed = "";
            /*
			if(xioDocs.hasOwnProperty(projectId) && xioDocs[projectId].hasOwnProperty(uri) && xioDocs[projectId][uri] && !xioDocs[projectId][uri].isClean()) {
				changed = " changed ";
			}
            */

			var hidden  = (item.filename==='xiocode.properties' || item.filename==='xiocode.todo')? ' hidden' : '';
			title += item.size? toHumanReadableFileSize(item.size,true) : (item.leafs? item.leafs.length + " items": "empty");
			htm.push("<li draggable='true' class='"+imagePreview + changed + hidden+"' data-uri='" + uri + "' data-type='"+item.type+"' data-mime='"+item.mime+"' title='"+title+"'>");
			htm.push("<div class='file'>");
			htm.push("<svg class='icon " + item.icon + "'><use xlink:href='/icons.svg#icon-" + item.icon + "' /></svg>");
			if(item.leafs) {
				htm.push("<svg class='icon " + item.icon + " open'><use xlink:href='/icons.svg#icon-" + item.icon + "-open' /></svg>");
			}
			htm.push("<div class='filename'>" + item.filename + "</div></div>");
			//htm.push("<span class='icon-"+item.icon+"'>"+item.filename+"</span>");
			if(item.leafs) {
				htm.push(printFolder(item.leafs, item.path));
			}
			htm.push("</li>");
		}
		htm.push("</ul>");
		return htm.join("");
	}

	var selectFile = function(uri) {
		deselectAll();

		console.log("Select: '" + uri + "' in fileList");
		var li = fileList.querySelector("li[data-uri='"+uri+"']");
		if(li) {
			li.classList.add("selected");

			//Open all parent folders
			var parent = li.parentElement;
			while(parent!=fileList) {
				if(parent.nodeName==="LI") {
					openFolder(parent);
				}
				parent = parent.parentElement;
			}
		}
	};

	var deselectAll = function(uri) {
		var items = fileList.querySelectorAll("li");
		for(var i = 0; i<items.length; i++) {
			items[i].classList.remove("selected");
		}
	};

	var clear = function() {
		if(!fileList) init();
		files = null;
		fileList.innerHTML = "Loading...";
	};

	var clickHandler = function(e) {
		var target = e.target;
		while(target.nodeName !== "LI" && target !== fileList) {
			target = target.parentElement;
		}

		hideFileListRightClickMenu();

		if(e.button===0) {
			if(target!==fileList) {
				var uri = target.dataset.uri;
				var file = files[uri];

				if(file.type==='folder') {
					toggleFolder(target);
				} else if(e.type==="dblclick") {
					if(['zip','tar','rar','psd','xsl','doc','xslx','docx'].indexOf(file.type)!=-1) {
						console.log("Download file...");
						window.location.href = "/scripts/file_handler.php?action=download&project_id="+projectId+"&uri="+uri;
					} else if(['jpg','png','pdf','gif','bmp'].indexOf(file.type)!=-1) {
						console.log("Open preview in new tab");
						window.open(projectsURL + projectId + "/" + uri);
					} else {
						console.log("Open file", uri);
						XioCode.getActiveCodeEditor().openFile(uri);
					}
				} else {
					selectFile(uri);
				}
				e.stopPropagation();
			}
		} else if(e.button===2) {
			if(e.ctrlKey || e.altKey) return true;

			if(target===fileList) {
				showRootRightClickMenu("", e);
			} else {
				var uri = target.dataset.uri;
				target.classList.add("rightClicked");
				showFileListRightClickMenu(uri, e);
			}
			e.preventDefault();
		}
	};


	function toggleFolder(li) {
		var folderIcon = li.querySelector("svg");
		if(li.classList.contains("open")) {
			closeFolder(li);
		} else {
			openFolder(li);
		}
	}
	function openFolder(li) {
		var uri = li.dataset.uri;
		var index = openedFolders.indexOf(uri);
		if (index === -1) {
			openedFolders.push(uri);
		}
		li.classList.add("open");

		var folderList = li.querySelector("ul");
		folderList.style.display="block";
	}
	function closeFolder(li) {
		var uri = li.dataset.uri;
		var index = openedFolders.indexOf(uri);
		if (index > -1) {
			openedFolders.splice(index, 1);
		}
		li.classList.remove("open");

		var folderList = li.querySelector("ul");
		folderList.style.display="none";
	}


	var showSpinner = function(uri) {
		var li = fileList.querySelector("li[data-uri='"+uri+"']");
		if(li) {
			var span = document.createElement("span");
			span.classList.add("spinner", "icon-spinner");
			li.appendChild(span);
		}
	};
	var hideSpinner = function(uri) {
		var spinner = fileList.querySelector("li[data-uri='"+uri+"'] span.spinner");
		if(spinner) spinner.parentElement.removeChild(spinner);
	};



	var setFileAsClean = function(uri) {
		var li = fileList.querySelector("li[data-uri='"+uri+"']");
		if(li) li.classList.remove("changed");
	};
	var setFileAsDirty = function(uri) {
		var li = fileList.querySelector("li[data-uri='"+uri+"']");
		if(li) li.classList.add("changed");
	};


	function uploadFiles(filesToUpload, folder, overwrite) {
		console.log("start upload:", filesToUpload, "to", folder);

		var uploadData = new FormData();
		uploadData.append('path', folder);
		uploadData.append('project_id', activeProject.id);
		var fileUploadCount = 0;
	  	var xhr;

		for (var i=0; i<filesToUpload.length; ++i) {
		var file = filesToUpload[i];
			var checkData = new FormData();
			checkData.append('file', folder + file.name);
			checkData.append('project_id', activeProject.id);
			xhr = new XMLHttpRequest();
			xhr.open('POST', "/scripts/check_collision.php", false);
			xhr.send(checkData);
			if(xhr.status === 409) {
				if(!confirm(xhr.responseText + ", Do you want to overwrite the file?")) {
					continue;
				}
			} else if(xhr.status !== 202) {
				continue;
			}
			uploadData.append(file.name, file);
			fileUploadCount++;
		}

		if(fileUploadCount>0) {
			xhr = new XMLHttpRequest();
			xhr.open('POST', "/scripts/file_upload.php", true);
			xhr.onload = function(e) {
				if(xhr.status === 200) {
					FileList.loadProjectFiles();
				} else {
					console.log("Error uploading file:");
					console.log(filesToUpload);
				}
			};

			xhr.upload.onprogress = function(e) {
				/*
				console.log(e);
				if (e.lengthComputable) {
			progressBar.value = (e.loaded / e.total) * 100;
					progressBar.textContent = progressBar.value; // Fallback for unsupported browsers.
				}
				*/
			};
			xhr.send(uploadData);
		}
	}




	var dragFile = function(e) {
		var target = e.target;
		while(target.nodeName !== "LI") {
			target = target.parentElement;
			if(target === fileList) return;
		}

		var uri = target.dataset.uri;
		var file = files[uri];

		var mime = "css/text"; //target.dataset.mime;
		var filePath = location.origin + "/scripts/file_handler.php?action=load_raw&project_id=" + projectId + "&uri=" + encodeURI(uri);
		var fileDetails = mime + ":" + file.filename + ":" + filePath;
		e.dataTransfer.setData("DownloadURL", fileDetails);
		e.dataTransfer.setData("uri", uri);
		e.stopPropagation();
	};

	var dropFile = function(e) {
		hoverFile(e);

		var target = e.target;
		while(target!==fileList) {
			if(target.nodeName === "LI" && target.dataset.type === "folder") break;
			target = target.parentElement;
		}

		if(target===fileList) {
			var folder = "";
		} else {
			var folder = target.dataset.uri+"/";
		}

		var fileDragged = e.dataTransfer.getData("uri");

		if(fileDragged) {
			// Move files
			var newUri = folder+files[fileDragged].filename;
			if(newUri === fileDragged) {
				console.log("drop to same place, abort");
			} else {
				Ajax.post2JSON("/scripts/file_handler.php", {'action':'rename', 'project_id': projectId, 'uri': fileDragged, 'new_uri': newUri},
					function(e) {
						FileList.loadProjectFiles();
					}
				);
			}
		} else {
			// Upload files
			var filesToUpload = e.target.files || e.dataTransfer.files;
			console.log("upload files:", filesToUpload);
			if(filesToUpload.length > 0) {
				uploadFiles(filesToUpload, folder, false);
				return;
			}
		}

	};

	var hoverFile = function(e) {
		e.preventDefault();

		var target = e.target;
		while(target!==fileList) {
			if(target.nodeName === "LI" && target.dataset.type === "folder") break;
			target = target.parentElement;
		}

		if(e.type === "dragover") {
			target.classList.add("dropTo");
		} else {
			target.classList.remove("dropTo");
		}
	};



	var rightClickClickHandler = function(e) {
		var target=e.target;
		var uri = rightClickMenu.dataset.uri;
		var path = (uri)? files[uri].path : "";
		var filename = (uri)? files[uri].filename : "";
		var isFolder = (uri)? files[uri].type==='folder' : false;
		switch(target.dataset.do) {

			case "newFolder":
			XioPop.prompt({title:"New folder", text:"Enter the name of the folder", onSubmit:function(folderName) {
				if(folderName) {
					if(isFolder) path+=filename + "/";
					Ajax.get("/scripts/create_folder.php", {'project_id':projectId, 'uri':encodeURI(path + folderName)}, function() {
						FileList.loadProjectFiles();
					});
				}
			}});
			break;

			case "newFile":
			if(isFolder) path+=filename + "/";
			createNewFile(path);
			break;

			case "saveAs":
			XioPop.prompt({title:"Save as", text:"Enter the new name of the file/folder", value:filename, onSubmit:function(newName) {
				if(newName) {
					saveFileAs(newName, false);
				}
			}});
			break;

			case "refresh":
			FileList.loadProjectFiles();
			break;

			case "delete":
			if(isFolder) {
				var title = "Delete folder";
				var question = "Are you sure you want to delete the folder '"+uri+"' and all of its content?";
			} else {
				var title = "Delete file";
				var question = "Are you sure you want to delete the file: '"+uri+"'?";
			}
			XioPop.confirm({title:title, text:question, onSubmit:function(answer) {
				if(answer) {
					Ajax.post2JSON("/scripts/file_handler.php",  {'action':'delete', 'project_id':activeProject.id, 'uri':uri}, function(json) {
						FileList.loadProjectFiles();

						for(var i=0; i<XioCode.getPanes().length; i++) {
							var pane = XioCode.getPanes()[i];
							if(pane.type === 10) {
								var file = File.getFileByUri(projectId, json.uri);
								if(file) file.close();
							}
						}

						/*
						var openedUris = Object.keys(xioDocs[activeProject.id]);
						var docsToClose = [];
						for(var i=0; i<openedUris.length; i++) {
							var openUri = openedUris[i];
							if(openUri===json.uri || openUri.substr(0,json.uri.length+1)===json.uri+"/") {
								docsToClose.push(openUri);
							}
						}
						closeDocs(activeProject.id, docsToClose);
						*/
					});
				}
			}});
			break;

			case "rename":
			XioPop.prompt({title:"Rename file", text:"Enter the new name of the file/folder", value:filename, onSubmit:function(newName) {
				if(newName) {
					renameFile(uri, path+newName);
				}
			}});
			break;

			case "export":
			window.location.href = "/scripts/file_handler.php?action=download&project_id="+projectId+"&uri="+uri;
			break;

			case "upload":
			XioPop.alert({title:"upload file...", text:"not implemented yet "});
			break;

			case "preview":
			previewFile(uri);
			break;

		}
		hideFileListRightClickMenu();
	};


	function showFileListRightClickMenu(uri, e) {
		rightClickMenu.classList.remove("hidden");
		var top = e.pageY;
		if(top+rightClickMenu.offsetHeight+10 > window.innerHeight) {
			top = window.innerHeight - rightClickMenu.offsetHeight - 10;
		}
		rightClickMenu.dataset.uri = uri;
		rightClickMenu.style.top = top + "px";
		rightClickMenu.style.left = e.pageX + "px";
	}

	function showRootRightClickMenu(uri, e) {
		showFileListRightClickMenu(uri, e);
		rightClickMenu.classList.add("root");
	}

	function hideFileListRightClickMenu() {
		rightClickMenu.classList.add("hidden");
		rightClickMenu.classList.remove("root");

		var elements = fileList.getElementsByClassName("rightClicked");
		for(var i=0; i<elements.length; i++) {
			elements[i].classList.remove("rightClicked");
		}
	}

	var getFiles = function() {
		return files;
	}

	var hide = function() {
		fileList.style.display="none";
	}
	var show = function() {
		fileList.style.display="block";
	}




	return {
		loadProjectFiles: loadProjectFiles,
		setProjectId: setProjectId,
		clear: clear,
		showSpinner: showSpinner,
		hideSpinner: hideSpinner,
		getFiles: getFiles,
		setFileAsClean: setFileAsClean,
		setFileAsDirty: setFileAsDirty,
		hide: hide,
		show: show,
		selectFile: selectFile,
		deselectAll: deselectAll
	}

})();
var GateKeeper = (function() {

	var
	ACCESS_CHECK_INTERVAL=5*60*1000, //Every 5 minutes

	user,

	loginBox, frmLogin, btnLogin, txtUsername, txtPassword, username,
	checkAccessInterval, onLoginCallback, onLogoutCallback,

	btnGoogleLogin,




	init = function(callbackLogin, callbackLogout) {
		onLoginCallback = callbackLogin;
		onLogoutCallback = callbackLogout;

		loginBox = document.getElementById("login");

		frmLogin = document.getElementById("loginForm");
		frmLogin.addEventListener("submit", loginRequest, false);

		btnLogin = document.getElementById("btnLogin");
		txtUsername = frmLogin.elements.code_username;
		txtPassword = frmLogin.elements.code_password;

		btnGoogleLogin = document.getElementById("btnGoogleLogin");
		btnGoogleLogin.addEventListener("click", loginUsingGoogle, false);
	},

	loginRequest = function(e) {
		e.preventDefault();
		if(!txtUsername.value || !txtPassword.value) {
			return;
		}

		btnLogin.disabled=true;
		btnLogin.textContent="Authorizing...";

		Ajax.post2JSON("/scripts/gatekeeper.php?action=login", frmLogin, loginCallback);
	},

	loginCallback = function(response) {
		if(response.status===STATUS_OK) {
			user = response.user;
			loginAccepted();
		}
		else {
			console.warn("Incorrect login or password");
			loginBox.className="";
			setTimeout(function(){
				loginBox.classList.add("shake");
			},1);
		}
		frmLogin.reset();
		btnLogin.disabled=false;
		btnLogin.textContent="Login";
		txtUsername.focus();
	},

	loginAccepted = function() {
		console.log("Welcome", user.username);

		//Access check every minute
		checkAccessInterval = setInterval(checkAccess, ACCESS_CHECK_INTERVAL);

		if(onLoginCallback) onLoginCallback(user);
	},

	logout = function() {
		Ajax.post("/scripts/gatekeeper.php?action=logout");
		clearInterval(checkAccessInterval);

		if(onLogoutCallback) onLogoutCallback();

		showLogin();
	},

	showLogin = function() {
		document.body.classList.remove("authorized");
		document.title = pageTitle + " - Login";
		frmLogin.reset();
		btnLogin.disabled=false;
		btnLogin.textContent="Login";
		txtUsername.focus();
	},


	checkAccess = function() {
		console.log(new Date().toTimeString().substr(0,5), "Access check");
		Ajax.getJSON("/scripts/gatekeeper.php", {action: "check", user_id: user.user_id}, function(json) {
			if(json.status !== STATUS_OK) {
				console.warn(json.message);
				console.debug("Force logout");
				logout();
			}
		});
	},

	setUser = function(u) {
		user = u;
		loginAccepted();
	},


	loginUsingGoogle = function(e) {
		var url = e.target.dataset.url,
			title = "Google login",
			w = 500,
			h = 600,
			left = (screen.width/2)-(w/2),
  			top = (screen.height/2)-(h/2),
			options = 'toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=no, resizable=no, copyhistory=no, width='+w+', height='+h+', top='+top+', left='+left;
  		window.open(url, title, options);
	},

	googleLoginCallback = function(data) {
		setUser(data.user);
	};


	return {
		init: init,
		showLogin: showLogin,
		logout: logout,
		setUser: setUser,
		googleLoginCallback: googleLoginCallback
	}
}());

var Preview = (function() {

	var
	container, frame,
	visible=false,
	refreshOnSave=false,

	init = function() {
		console.log("Init preview");
		container = document.getElementById("preview");
		frame = document.getElementById("previewFrame");

		window.addEventListener("resize", fixLayout, false);

		hide();
	},


	show = function() {
		visible=true;
		container.style.display = "flex";
		fixLayout();
	},

	hide = function() {
		visible=false;
		container.style.display = "none";
	},

	load = function(url) {
		frame.src=url;
	},

	refresh = function() {
		if(!visible) return;
		console.log("Refresh preview", frame.src);
		if(frame.src!=="blank") {
			frame.src = frame.src;
		}
	},

	isVisible = function() {
		return visible;
	},

	doRefreshOnSave = function() {
		return visible && refreshOnSave;
	},

	fixLayout = function() {
		if(!visible) return;

		frame.style.height=(container.offsetHeight-15)+"px";
	};


	return {
		init: init,
		fixLayout: fixLayout,
		show: show,
		hide: hide,
		load: load,
		refresh: refresh,
		isVisible: isVisible,
		doRefreshOnSave: doRefreshOnSave
	}
}());
var ProjectConfig = (function() {
	var form, btnCancel, confTags, listTags, pop,

	open = function(projectId) {
		pop = XioPop.load({url:"/scripts/project_config.php?project_id="+projectId, onLoad:display});
	},

	display = function(e) {
		form = document.getElementById("frmProjectConfig");
		form.addEventListener("submit", onSubmit, false);
		btnCancel = document.getElementById("btnConfigCancel");
		btnCancel.addEventListener("click", close, false);
		confTags = document.getElementById("confTags");
		confTags.addEventListener("keypress", tagHandler, false);

		listTags = document.getElementById("listTags");
		listTags.addEventListener("click", tagHandler, false);
		displayTags();
	},

	onSubmit = function(e) {
		e.preventDefault();
		console.log("Save project configurations...");
		Ajax.post2JSON("/scripts/project_config.php?action=save", form, onSaveCallback);
	},

	onSaveCallback = function(data) {
		switch(data.status) {
			case STATUS_OK:
			console.log("Project configurations saved!");
			close();
			ProjectList.loadProjects();
			break;

			case STATUS_FILE_COULD_NOT_UPDATE:
			XioPop.alert({title:"Permission denied", text:"You do not have sufficient permission to update project config file"});
			break;

			default:
			XioPop.alert({title:"Error", text:"Unknown error while saving project config"});
		}
	},

	tagHandler = function(e) {
		if(e.type === "keypress" && e.keyCode === KEY_ENTER) {
			e.preventDefault();
			var text = e.target.value.trim();
			if(text) {
				console.log("add tag");
				var input = document.createElement("input");
				input.type="hidden";
				input.value=text;
				input.name="config[tags][]";
				form.appendChild(input);
				displayTags();
				e.target.value="";
			}
		} else if(e.type === "click" && e.target.nodeName==="LI") {
			console.log("input[value='"+e.target.textContent+"']");
			form.removeChild(form.querySelector("input[value='"+e.target.textContent+"']"));
			displayTags();
		}
	},

	displayTags = function() {
		var tags = form.querySelectorAll("input[name='config[tags][]']");
		listTags.innerHTML = "";
		if(tags) {
			console.log("taggar", tags);
			for(var i=0; i<tags.length; i++) {
				var tag = tags[i].value;
				var li = document.createElement("LI");
				li.textContent = tag;
				listTags.appendChild(li);
			}
		}
	},

	close = function(e) {
		pop.close();
	};



	return {
		open: open
	};
})();
var ProjectList = (function() {

	var projects, projectOrder="name", projectOrderDir="asc", lastSearchString;
	var projectList, txtProjectFilter, btnNewProject, listProjectOrderBy;
	var tags, listTags;

	XI.listen("DOMContentLoaded", function(e) {
		console.log("Init ProjectList");
		projectList = document.getElementById('projectList');
		projectList.addEventListener("click", clickHandler, false);
		projectList.addEventListener("mouseover", hoverSelect, false);
		projectList.addEventListener("drop", dropHandler, false);
		projectList.addEventListener("dragover", dropHandler, false);
		projectList.addEventListener("dragleave", dropHandler, false);


		txtProjectFilter = document.getElementById('txtProjectFilter');
		txtProjectFilter.addEventListener("search", filterProjects);
		txtProjectFilter.addEventListener("keydown", keyDown);
		txtProjectFilter.addEventListener("keyup", filterProjects);

		btnNewProject = document.getElementById("btnNewProject");
		btnNewProject.addEventListener("click", addNewProject, false);

		listTags = document.getElementById("listProjectTags");

		listProjectOrderBy = document.getElementById("listProjectOrderBy");
		listProjectOrderBy.addEventListener("change", selectOrderBy, false);
	});

	var loadProjects = function() {
		Ajax.getJSON("/scripts/get_projects.php", null, function(json) {
			projects = json;
			console.log("%i projects loaded", Object.keys(projects).length, projects);
			getUniqueTags();

			XI.fire('projectsLoaded');
		});
	};

	XI.listen(['projectsLoaded', 'DOMContentLoaded', 'orderProjects'], function(){
		printProjects();

		filterProjects();

		if(activeProject) {
            var pId = activeProject.id
            activeProject = projects[pId];
            activeProject.id = pId;
            document.title = pageTitle + " - " + activeProject.name;
            title.textContent = activeProject.name;
        }
	}, true);



	var selectOrderBy = function(e) {
		var option = e.target.selectedOptions[0];
		setOrderBy(option.dataset.order, option.dataset.order_dir);

		Ajax.post("/scripts/save_user_settings.php", {"projects_order_by":projectOrder, "projects_order_dir":projectOrderDir}, function(e) {
			console.log("User settings callback", e);
		});
	};

	var setOrderBy = function(column, dir) {
		if(projectOrder!==column || projectOrderDir !== dir) {
			projectOrder = column;
			projectOrderDir = dir;

			var option = listProjectOrderBy.querySelector("option[data-order='"+projectOrder+"'][data-order_dir='"+projectOrderDir+"']");
			if(option) option.selected="true";
		}
		XI.fire("orderProjects");
	};

	var getUniqueTags = function() {
		tags = [];
		for (var pId in projects) {
			if (projects.hasOwnProperty(pId)) {
				var t = projects[pId].tags;
				if(t) {
					t.forEach(function(tag, i) {
						if(tags.indexOf(tag)===-1) {
							tags.push(tag);
						}
					});
				}
			}
		}
	};


	var updateTagList = function() {
		listTags.innerHTML="";
		tags.forEach(function(tag, i) {
			var li = document.createElement("LI");
			li.textContent = tag;
			listTags.appendChild(li);
		});
	}


    var printProjects = function() {
		var sel = projectList.querySelector(".selected");
		var projectIds = Object.keys(projects);
		projectIds = sortProjects(projectIds, projectOrder);

        var ul = document.createElement("ul");
		projectIds.forEach(function(id, i) {
			var item = projects[id];

			var tpl = document.getElementById("tplProjectListItem").content;
			var li = tpl.querySelector("li");
			li.dataset.project_id = id;
			var name = tpl.querySelector(".name");
			name.textContent = item.name;
			var description = tpl.querySelector(".description");
			description.textContent = item.description||"";
			var project = document.importNode(tpl, true);
			ul.appendChild(project);
		});
		projectList.innerHTML="";
		projectList.appendChild(ul);


		if(sel) {
			var id = sel.dataset.project_id;
			projectList.querySelector("li[data-project_id="+id+"]").classList.add("selected");
		}

		lastSearchString="";

        updateTagList();
    };


	var clickHandler = function(e) {
		var target = e.target;
		var action;

		if(target.nodeName==="LI") {
			action = target.dataset.action;
			console.log("Do", action);
			e.preventDefault();
		}

		var p = target;
		while(!p.classList.contains("project")) {
			if(p===projectList) return;
			p = p.parentElement;
		}
		var projectId = p.dataset.project_id;

		switch(action) {

			case "delete":
			var project = projects[projectId];
			XioPop.confirm({title:"Delete project?", text:"Are you sure you want to delete project '"+project.name+"'?", onSubmit:function(answer) {
				if(answer) {
					var formData = new FormData();
					formData.append("project_id", projectId);
					var xhr = new XMLHttpRequest();
					xhr.open('POST', "/scripts/delete_project.php", true);
					xhr.onload = function(e) {
						var xhr = e.target;
						if(xhr.status===200) {
							console.log("Project deleted");
							loadProjects();
						} else {
							console.err("Error deleting project", xhr);
						}
					};
					xhr.send(formData);
				} else {
					console.debug("Delete aborted");
				}
			}});
			break;

			case "rename":
			XioPop.prompt({title:"Rename project", text:"Enter a new name for the project", value:projects[projectId].name, onSubmit:function(newName) {
				if(newName) {
					var formData = new FormData();
					formData.append("new_name", newName);
					formData.append("project_id", projectId);
					var xhr = new XMLHttpRequest();
					xhr.open('POST', "/scripts/rename_project.php", true);
					xhr.onload = function(e) {
						var xhr = e.target;
						if(xhr.status===200) {
							console.log("Project renamed");
							findProjects();
						} else {
							console.err("Error renaming project", xhr);
						}
					};
					xhr.send(formData);
				}
			}});
			break;

			case "config":
			ProjectConfig.open(projectId);
			break;

			case "run":
			previewProject(projectId);
			break;


			default:
			setHash(projectId);
		}
	};

	var hoverSelect = function(e) {
		var target = e.target;
		while(!target.classList.contains("project")) {
			if(target === projectList) return;
			target = target.parentElement;
		}
		deselectAll();
		target.classList.add("selected");
	};

	var deselectAll = function() {
		var selected = projectList.getElementsByClassName("selected");
		for(var i=0; i<selected.length; i++) {
			selected[i].classList.remove("selected");
		}
	};

	var keyDown = function(e) {
		if(e.which === KEY_ENTER) {
			var projectElement = projectList.querySelector(".selected");
			setHash(projectElement.getAttribute('data-project_id'));
			e.preventDefault();
		} else if(e.which === KEY_DOWN) {
			selectNextVisible();
			e.preventDefault();
		} else if(e.which === KEY_UP) {
			selectNextVisible(true);
			e.preventDefault();
		} else {
			filterProjects();
		}
	};


	function filterProjects(e) {
		if(!projects) return;

		var searchString = txtProjectFilter.value.toLowerCase();
		if(searchString===lastSearchString) return;
		lastSearchString=searchString;
		console.log("filter projects '"+searchString+"'", txtProjectFilter, projects);

		for(var id in projects) {
			if (projects.hasOwnProperty(id)) {
				var project = projects[id];

				var p = projectList.querySelector(".project[data-project_id='"+id+"']");
				if(project.name.toLowerCase().search(searchString)!=-1) {
					p.classList.remove('hidden');
				} else {
					p.classList.add('hidden');
				}
			}
		}
		var sel = projectList.querySelector(".selected");
		if(!sel || sel.classList.contains("hidden")) {
			var found = selectNextVisible(true);
			if(!found) selectNextVisible();
		}
	}

	function sortProjects(projectIds) {
		projectIds.sort(function(id1,id2) {
			var p1 = projects[id1];
			var p2 = projects[id2];

			switch(projectOrder) {
				case "name":
				var n1 = p1.name.toLowerCase();
				var n2 = p2.name.toLowerCase();
				if (n1 < n2) return -1;
				if (n1 > n2) return 1;
				return 0;

				case "created":
				var c1 = p1.created || 0;
				var c2 = p2.created || 0;
				return c2-c1;

				case "opened":
				var c1 = p1.last_opened || 0;
				var c2 = p2.last_opened || 0;
				return c2-c1;
			}
		});
		if(projectOrderDir==="desc") {
			projectIds.reverse();
		}
		return projectIds;
	}

	var selectNextVisible = function(rev){
		var sel = projectList.querySelector(".selected");
		if(sel) {
			var sib = rev? sel.previousElementSibling : sel.nextElementSibling;
			while(sib !== null) {
				if(!sib.classList.contains("hidden")) {
					deselectAll();
					sib.classList.add("selected");
					return true;
				}
				sib = rev? sib.previousElementSibling : sib.nextElementSibling;
			}
		} else {
			//Select first project
			sel = projectList.querySelector(".project");
			deselectAll();
			if(sel) sel.classList.add("selected");
			return true;
		}
		return false;
	};

	var dropHandler = function(e) {
		switch(e.type) {

			case "dragover":
			projectList.classList.add("dropzone");
			e.preventDefault();
			break;

			case "dragleave":
			projectList.classList.remove("dropzone");
			break;

			case "drop":
			e.preventDefault();
			projectList.classList.remove("dropzone");
			var items = e.dataTransfer.items;
			handleDroppedItems(items);
			break;
		}

	};

	var addNewProject = function() {
		XioPop.prompt({title:"Enter the project's name", onSubmit:function(projectName) {
			if(projectName) {
				var xhr = new XMLHttpRequest();
				xhr.open("get", "/scripts/new_project.php?projectName="+projectName, true);

				xhr.onload = function(e) {
					if(e.target.status===200) {
						loadProjects();
					}
				};
				xhr.send();
			}
		}});
	};

	var getProject = function(id) {
		if(projects && projects.hasOwnProperty(id)) {
			return projects[id];
		}
		return false;
	};

	var clear = function() {
		projects = null;
		projectList.innerHTML = "";
	};

	var updateLastOpened = function(projectId) {
		Ajax.post2JSON("/scripts/project_config.php?action=updateLastOpened", {project_id: projectId}, function(json) {
			if(json.status===STATUS_OK) {
				if(projects && projects.hasOwnProperty(projectId)) {
					projects[projectId].last_opened = json.last_opened;
				}
			} else {
				XioPop.alert({title:"Permission error", text:"Insuffient permission to update project last opened date in project config file."});
			}
		});
	};

	var handleDroppedItems = function(items) {
		console.log("dropped items:", items);

		var rootEntries = [];
		for(var i=0; i<items.length; i++) {
			var item = items[i];
			console.log("root item"+i, item.kind);

			switch(item.kind) {
				case "file":
				var entry = item.webkitGetAsEntry();
				if(entry) rootEntries.push(entry);
				break;

				default:
				console.warn("Drop does not handle items of type:", item.kind);
				console.debug(item);
			}
		}

		if(rootEntries.length>0) {
			console.log("Vad vill du göra med dessa", rootEntries.length, "root items");


			var options = [
				{id:"OneProject", text:"Create one project including these items"},
				{id:"SplitProjects", text:"Split up into " + rootEntries.length + " separate projects"}
			];
			XioPop.choose({title:"Drop action", text:rootEntries.length+" items was dropped, what do you want to do with them?", options:options, onSubmit:chooseCallback});

			function chooseCallback(answer) {
				console.log("Answer:", answer);
			}

		}

		function handleEntry(entry) {
			if(entry.isDirectory) {
				console.log("DIR FOUND:", entry.fullPath);
				handleDirectory(entry);
			} else {
				handleFile(entry);
			}
		}

		function handleDirectory(dir) {
			var directoryReader = dir.createReader();
			var readEntries = function() {
				directoryReader.readEntries (function(results) {
					if (!results.length) {
						console.log("done", dir.fullPath);
					} else {
						for(var i=0; i<results.length; i++) {
							handleEntry(results[i]);
						}
						readEntries();
					}
				}, errorHandler);
			};
			var errorHandler = function(e) {
				console.log("error:", e);
			}
			readEntries();
		}

		function handleFile(file) {
			console.log("FILE:", file.fullPath);
		}
	}




	return {
		clear: clear,
		setOrderBy: setOrderBy,
		getProject: getProject,
		loadProjects: loadProjects,
		updateLastOpened: updateLastOpened
	};
})();
(function() {

	var filename;
	var template = document.getElementById('tplCodeEditorTab').content;


	var _ = self.Tab = function(parent, file) {

		this.parent = parent;
		this.file = file;
		this.file.tab = this;


		var li = template.querySelector("li");
		li.dataset.id = file.id;

		filename = template.querySelector(".filename");
		this.updateFromFile();

		var fragment = document.importNode(template, true);
		this.parent.tabList.appendChild(fragment);

		this.elem = this.parent.tabList.querySelector("li[data-id='"+file.id+"']");
		this.elem.addEventListener("click", this.clickHandler.bind(this), false);
		filename = this.elem.querySelector(".filename");

		this.updateState();

	}


	_.prototype = {

		remove: function() {
			this.parent.tabList.removeChild(this.elem);
		},

		select: function() {
			this.elem.classList.add("selected");
		},

		deselect: function() {
			this.elem.classList.remove("selected");
		},

		updateFromFile: function() {
			filename.textContent = this.file.filename
			filename.title = this.file.uri;
		},

		updateState: function() {
			var classes = this.elem.classList;
			classes.remove("loading");
			classes.remove("saving");


			if(this.file.doc.isClean()) {
				classes.remove("changed");
			} else {
				classes.add("changed");
			}

			console.log("file state", this.file.state);
			switch(this.file.state) {
				case File.STATE_LOADING:
				this.elem.classList.add("loading");
				break;

				case File.STATE_READY:
				break;

				case File.STATE_SAVING:
				classes.add("saving");
				break;
			}
		},

		clickHandler: function(e) {
			console.log("tabClick", e);
			if(e.target.nodeName==="svg" || e.target.nodeName==="use" || e.which===2) {
				this.file.close();
				return;
			}
			this.parent.codeEditor.switchToFile(this.file);
		}


	};


}())
function TabBar(tabList, codeEditor) {
	this.tabList = tabList;
	this.codeEditor = codeEditor;
	this.tabs = [];
}


TabBar.prototype.select = function(tabToSelect) {
	for(var i=0; i<this.tabs.length; i++) {
		var tab = this.tabs[i];
		if (tab === tabToSelect) {
			tab.select();
		} else {
			tab.deselect();
		}
	}
};


TabBar.prototype.add = function(file) {
	var tab = new Tab(this, file);
	this.tabs.push(tab);
	file.setTab(tab);
};


TabBar.prototype.remove = function(tab) {
	for(var i=0; i<this.tabs.length; i++) {
		if(this.tabs[i]===tab) {
			this.tabs.splice(i,1);
		}
	}
	tab.remove();
};


TabBar.prototype.clear = function() {
	this.tabList.innerHTML = "";
	this.tabs.length = 0;
};
var Todo = (function() {

	var btnAddFeature, btnAddBug,
	list, listDone, dragElem, dragUp, dragY,
	projectId, todos, pop,

	init = function() {
		btnAddFeature = document.getElementById("btnAddFeature");
		btnAddFeature.addEventListener("click", addFeature, false);

		btnAddBug = document.getElementById("btnAddBug");
		btnAddBug.addEventListener("click", addBug, false);

		list = document.getElementById("listTodos");
		list.addEventListener("click", clickHandler, false);
		list.addEventListener("dragover", dragHandler, false);
		list.addEventListener("dragenter", dragHandler, false);
		list.addEventListener("dragleave", dragHandler, false);
		list.addEventListener("dragstart", dragHandler, false);
		list.addEventListener("dragend", dragHandler, false);

		listDone = document.getElementById("listTodosDone");
		listDone.addEventListener("click", clickHandler, false);
	},

	clickHandler = function(e) {

		if(e.type==="click") {

			var li = e.target;
			while(li.nodeName!=="LI") {
				if(li===list) return;
				li=li.parentElement;
			}

			var todoId = li.dataset.id;
			var todo = todos[todoId];
			console.log("clicked on", todoId);
			createTodoForm({
				todoId: todoId,
				type: todo.type,
				status: todo.status,
				created: todo.created,
				edited: todo.edited,
				title: "Edit " + todo.type + ": " + todoId,
				description: todo.description
			});
		}
	},

	dragHandler = function(e) {

		if(e.type==="dragenter" || e.type==="dragleave") {
			var li = e.target;
			while(li.nodeName!=="LI") {
				if(li===list) return;
				li=li.parentElement;
			}
		}

		switch(e.type) {
			case "dragenter":
				e.preventDefault();
				list.insertBefore(dragElem, dragUp ? li : li.nextSibling);
				break;

			case "dragstart":
				dragElem = e.target;
				dragElem.classList.add("dragged");
				list.classList.add("reordered");
				//empty pixel as drag image
				var dragGhost = document.createElement("img");
				dragGhost.src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7";
				e.dataTransfer.setDragImage(dragGhost, -10, -10);
				break;

			case "dragend":
				list.classList.remove("reordered");
				e.target.classList.remove("dragged");
				var items = list.children;
				var ids = [];
				for(var i=0; i<items.length; i++) {
					ids.push(items[i].dataset.id);
				}
				var formData = new FormData();
				formData.append("project_id", projectId);
				formData.append("prio", ids);
				Ajax.post2JSON("/scripts/todo_handler.php", formData, prioritizeCallback);
				break;

			case "dragleave":
				e.preventDefault();
				break;

			case "dragover":
				e.preventDefault();
				if(dragY !== e.pageY) {
					dragUp = dragY > e.pageY;
				}
				dragY = e.pageY;
				break;
		}
	},

	prioritizeCallback = function(json) {
		console.log("prio", json);
	},

	loadAll = function(pId) {
		projectId = pId;
		clear();
		Ajax.getJSON("/scripts/todo_handler.php", {project_id:projectId, action:"getAll"}, function(json) {
			todos = json.todos;
			XI.fire("todosLoaded");
		});
	},



	updateList = function() {
		list.innerHTML="";
		listDone.innerHTML="";

		var sortedTodoIds = Object.keys(todos).sort(function(a,b){
			return todos[a].prio-todos[b].prio;
		});

		for(var i in sortedTodoIds) {
			var todoId = sortedTodoIds[i];
			var todo = todos[todoId];
			var done = todo.status==="done";

			if(!todo.type) todo.type="feature";


			var li = document.createElement("LI");
			li.classList.add(todo.type)
			li.dataset.id = todoId;
			if(!done) li.draggable="true";

			var title = document.createElement("span");
			title.textContent = todo.description;
			title.classList.add("title");

			li.appendChild(title);
			if(done) {
				listDone.appendChild(li);
			} else {
				list.appendChild(li);
			}
		}
	},

	addFeature = function(e) {
		createTodoForm({
			type: "feature",
			title: "Add a new feature"
		});
	},

	addBug = function(e) {
		createTodoForm({
			type: "bug",
			title: "Add a new bug report"
		});
	},

	createTodoForm = function(settings) {
		var editMode = !!settings.todoId;


		var template = document.getElementById('tplTodoEdit').content;


		var hiddenId = template.querySelector("input[name=todo_id]");
		hiddenId.value = settings.todoId || "";

		var todoTimeCreated = template.querySelector("#todoTimeCreated");
		if(settings.created) todoTimeCreated.textContent = toHumanReadableDateTime(parseInt(settings.created));

		var todoTimeEdited = template.querySelector("#todoTimeEdited");
		if(settings.edited) todoTimeEdited.textContent = toHumanReadableDateTime(parseInt(settings.edited));

		var description = template.querySelector("textarea");
		description.textContent = settings.description || "";

		var title = template.querySelector("h3");
		title.textContent = settings.title;

		var radioTypeSelected = template.querySelector("input[name=type][value="+settings.type+"]");
		radioTypeSelected.checked="checked";

		if(!settings.status) settings.status="new";
		var radioStatusSelected = template.querySelector("input[name=status][value="+settings.status+"]");
		radioStatusSelected.checked="checked";

		pop = XioPop.showElement({element:document.importNode(template, true)});

		var form = document.getElementById("formTodo");
		form.addEventListener("submit", submitTodo, false);

		var btnDelete = form.querySelector("button.delete");
		btnDelete.dataset.todoId = settings.todoId;
		btnDelete.addEventListener("click", deleteTodo, false);

		description.focus();
	},

	submitTodo = function(e) {
		e.preventDefault();
		var formData = new FormData(e.target);
		formData.append("project_id", projectId);
		formData.append("ts", (new Date()).getTime());
		Ajax.post2JSON("/scripts/todo_handler.php", formData, submitCallback);
		closePop();
	},

	submitCallback = function(json) {
		switch(json.status) {
			case STATUS_OK:
			console.log("submit callback", json);
			todos[json.todo_id] = json.todo;
			updateList();
			break;

			case STATUS_FILE_COULD_NOT_UPDATE:
			XioPop.alert({title:"Permission denied", text:"You do not have sufficient permission to update project todo file"});
			break;

			default:
			XioPop.alert({title:"Error", text:"Unknown error while saving todo config"});
		}
	},

	deleteTodo = function(e) {
		var formData = new FormData();
		formData.append("project_id", projectId);
		formData.append("todo_id", e.target.dataset.todoId);
		Ajax.post2JSON("/scripts/todo_handler.php?action=delete", formData, deleteCallback);
		closePop();
	},

	deleteCallback = function(json) {
		console.log("delete callback", json);
		delete todos[json.todo_id];
		updateList();
	},

	clear = function() {
		list.innerHTML="";
		listDone.innerHTML="";
		todos = {};
	},

	closePop = function() {
		if(pop) {
			pop.close();
			pop=null;
		}
	};

	XI.listen("DOMContentLoaded", init);
	XI.listen(["DOMContentLoaded","todosLoaded"], updateList, true);

	return {
		loadAll: loadAll,
		clear: clear
	};
}());






(function() {
	"use strict";

	var _ = self.CodeEditor = function(parentElement) {
		this.elem = parentElement;
		this.activeFile = null;
		this.activeProjectId = null;

		var tpl = document.getElementById("tplCodeEditorHeader").content;
		parentElement.appendChild(document.importNode(tpl, true));

		this.tabList = parentElement.querySelector(".tabBar");
		this.tabBar = new TabBar(this.tabList, this);

		this.toolList = parentElement.querySelector(".toolbar");
		this.toolList.addEventListener("click", toolbarClickHandler.bind(this), false);
		this.btnSave = this.toolList.querySelector("li[data-action='save']");
		this.btnPreview = this.toolList.querySelector("li[data-action='preview']");
		this.btnNew = this.toolList.querySelector("li[data-action='new']");

		this.editor = new CodeMirror(parentElement, clone(codemirrorDefaults));
		this.editor.on("dragover", editorDragOver.bind(this));
		this.editor.on("drop", editorDrop.bind(this));
		this.editor.on("change", editorChange.bind(this));
		this.editor.on("focus", editorFocus.bind(this));
	};

	_.prototype = {

		updateFileStatus: function(file) {
			var onDisc = file.state!==File.STATE_UNSAVED;
			var clean = file.doc.isClean() && onDisc;
			var loading = file.state === File.STATE_LOADING || file.state === File.STATE_SAVING;

			if(clean) {
				FileList.setFileAsClean(file.uri);
			} else {
				FileList.setFileAsDirty(file.uri);
			}

			file.tab.updateState();

			if(file === this.activeFile) {
				if(onDisc) {
					this.btnPreview.classList.remove("disabled");
				} else {
					this.btnPreview.classList.add("disabled");
				}

				if(clean) {
					this.btnSave.classList.add("disabled");
				} else {
					this.btnSave.classList.remove("disabled");
				}
			}
		},


		setProjectId: function(pId) {
			if(this.activeProjectId === pId) return;
			this.activeProjectId = pId;
			this.clear();

			/*
			TODO!!! open file in only one codeEditor!!!
			*/

			var projectFiles = File.getProjectFiles(pId);
			var fileCount = Object.keys(projectFiles).length;
			if(fileCount>0) {
				var switchTo = null;
				for(var fileId in projectFiles) {
					if (projectFiles.hasOwnProperty(fileId)) {
						var file = projectFiles[fileId];
						this.tabBar.add(file);
						if(!switchTo) switchTo = file;
					}
				}
				if(switchTo) this.switchToFile(file);
			} else {
				console.log("Project has no files opened, HIDE!")
				this.btnSave.classList.add("disabled");
				this.btnPreview.classList.add("disabled");
				this.editor.setOption("readOnly", true);
			}
		},


		clear: function() {
			var doc = CodeMirror.Doc("");
			this.editor.swapDoc(doc);
			this.tabBar.clear();
			this.activeFile = null;
		},

		saveFile: function() {
			var file = this.activeFile;
			if(!file) return;
			if(file.state===File.STATE_UNSAVED || file.state===File.STATE_EMPTY) {
				this.saveFileAs(file, false);
			} else {
                this.editor.execCommand("removeTrailingSpaces");
				file.save(this.editor.getValue(), this.saveFileCallback.bind(this));
				this.updateFileStatus(file);
			}
		},

		saveFileCallback: function(file) {
			this.updateFileStatus(file);
			if(Preview.doRefreshOnSave()) {
				Preview.load(projectsURL + this.activeProjectId + "/" + file.uri);
				Preview.refresh();
			}
		},

		saveFileAs: function(file, overwrite) {
			console.log("Save As... ");
			var me = this;
			file.projectId = this.activeProjectId;
			XioPop.prompt({title:"Save file as...", text:"Enter the filename", value:file.uri, onSubmit:function(newUri) {
				if(newUri) {
					me.editor.execCommand("removeTrailingSpaces");
					file.saveAs(newUri, me.editor.getValue(), false, me.saveFileAsCallback.bind(me));
					me.updateFileStatus(file);
				}
			}});
		},

		saveFileAsCallback: function(file, response) {
			switch(response.status) {
				case STATUS_OK:
				console.log("file saved as ", file.uri);
				FileList.loadProjectFiles();
				this.updateFileStatus(file);
				file.tab.updateFromFile();
				this.calculateFileMode(file.uri);

				break;

				case STATUS_FILE_COLLISION:
				var me = this;
				XioPop.confirm({title:"File already exists", text:"Are you sure you want to overwrite "+response.uri+"?", onSubmit:function(answer) {
					if(answer) {
						file.saveAs(response.uri, me.editor.getValue(), true, me.saveFileAsCallback.bind(me));
						me.updateFileStatus(file);
					}
				}});
				break;

				default:
				console.warn("handle callback", response);
			}
		},

		calculateFileMode: function(uri) {
			if(uri) {
				var mime = getMimeByUri(uri);
				this.editor.setOption("mode", mime);
			}
		},

		newFile: function() {
			var file = new File(this);
			file.blank(this.activeProjectId);
			this.tabBar.add(file);
			this.switchToFile(file);
			this.editor.setOption("readOnly", false);
		},


		switchToFile: function(file) {
			this.editor.swapDoc(file.doc);
			this.activeFile = file;
			this.tabBar.select(file.tab);
			this.updateFileStatus(file);
			this.editor.focus();
		},

		switchToNext: function() {
			var tabs = this.tabList.children;
			console.log("active tab", this.activeFile.tab);
			var switchToId = null;
			for(var i=0; i<tabs.length; i++) {
				var tab = tabs[i];
				var fileId = parseInt(tab.dataset.id);
				if(fileId===this.activeFile.id) {
					if(switchToId===null) {
						console.log("next", tabs[i+1], tabs[i]);
						switchToId=parseInt(tabs[i+1].dataset.id);
					}
					break;
				} else {
					switchToId = fileId;
				}
			}
			var file = File.getFileById(switchToId);
			this.switchToFile(file);
		},

		openFile: function(uri) {
			var file = File.getFileByUri(this.activeProjectId, uri);
			if(file) {
				this.editor.setOption("readOnly", false);
			} else {
				file = new File(this);
				file.load(this.activeProjectId, uri, this.openFileCallback.bind(this));
				this.tabBar.add(file);
			}

			this.switchToFile(file);
		},


		openFileCallback: function(file) {
			if(this.activeFile === file) {
				var old = this.editor.swapDoc(file.doc);
				this.editor.setOption("readOnly", false);
				console.log("File opened with mode ", file.doc.modeOption);
			}
			this.updateFileStatus(file);
		},


		closeFile: function(file) {
			this.tabBar.remove(file.tab);

			if(this.activeFile === file) {
				console.log("close active file", file);

				if(this.tabList.children.length===0) {
					console.log("last file closed, HIDE!!!");
					this.btnSave.classList.add("disabled");
					this.btnPreview.classList.add("disabled");
					this.clear();
					this.editor.setOption("readOnly", true);
				} else {
					this.switchToNext();
				}
			} else {
				console.log("close file", file);
			}
			this.editor.focus();
		}
	};



	function toolbarClickHandler(e) {
		var li=e.target;
		if(li===this.toolList) return;
		while(li.parentElement!==this.toolList) {
			li = li.parentElement;
		}
		var action = li.dataset.action;
		switch(action) {
			case "save":
				this.saveFile();
			break;

			case "preview":
				previewFile(this.activeFile.uri);
			break;

			default:
			console.warn("toolbar action not implemented:", action);
		}
	}

	function editorDragOver(cm, e) {
		cm.setCursor(cm.coordsChar({left:e.x, top:e.y}));
		cm.focus();
	}

	function editorDrop(cm, e) {
		var uri = e.dataTransfer.getData("uri");
		if(uri) {
			var replace = uri;
			switch(true) {
				case uri.match(/css$/)!==null:
				replace = '<link rel="stylesheet" href="'+uri+'" type="text/css" />';
				break;

				case uri.match(/js$/)!==null:
				replace = '<script src="'+uri+'"></script>';
				break;

				case uri.match(/php$/)!==null:
				replace = 'require "'+uri+'";';
				break;
			}
			console.log("Drop on cm", uri);
			cm.replaceSelection(replace);
			e.preventDefault();
		}
	}

	function editorChange(cm, change) {
		if(this.activeFile) {
			this.updateFileStatus(this.activeFile);
		}
	}

	function editorFocus(cm, change) {
		XioCode.setActiveCodeEditor(this);
	}



}());
var codemirrorSnippets = {
	"html":		"<!doctype html>\n<html>\n\t<head>\n\t\t<title>Page Title</title>\n\t\t<meta charset=\"utf-8\" />\n\t\t<link rel=\"stylesheet\" href=\"style.css\" type=\"text/css\" />\n\t</head>\n\t<body>\n\t\t\n\t</body>\n</html>",
	"css":		"<link rel=\"stylesheet\" href=\"style.css\" type=\"text/css\" />",
	"mobile":	"<meta name=\"viewport\" content=\"width=device-width, initial-scale=1, maximum-scale=1\" />",
	"com":		"/**********************************************************\n\n\n**********************************************************/",
	"phperror":	"ini_set('display_errors',1);\nini_set('error_reporting', E_ALL ^ E_NOTICE);",
	"xhr": 		"xhr = new XMLHttpRequest();",
	"favicon": "<link rel=\"shortcut icon\" href=\"favicon.ico\" />"
};

var codemirrorDefaults = {
	lineNumbers: true,
	matchBrackets: true,
	autoCloseTags: true,
	autoCloseBrackets: true,
	autoClearEmptyLines: true,
	styleActiveLine: true,
	indentUnit: 4,
	indentWithTabs: true,
	colorpicker: true,
	smartIndent: true,
	theme: 'xio',
	highlightSelectionMatches: {showToken: /\w/},
	extraKeys: {
		"Tab"			: "tabWithAutoComplete",
		"Shift-Tab"		: "indentLess",
		"Ctrl-D" 		: "removeLines",
		"Cmd-D" 		: "removeLines",
		"Ctrl-N" 		: "newFile",
		"Cmd-N" 		: "newFile",
		"Ctrl-S" 		: "shortcutSave",
		"Cmd-S" 		: "shortcutSave",
		"Alt-Up"		: "swapLineUp",
		"Alt-Down"		: "swapLineDown",
		"Ctrl-Alt-Down" : "duplicateRowDown",
		"Cmd-Alt-Down" 	: "duplicateRowDown",
		"Ctrl-Alt-Up" 	: "duplicateRowUp",
		"Cmd-Alt-Up" 	: "duplicateRowUp",
		"Cmd-I" 		: "selectLines",
		"Ctrl-I" 		: "selectLines",
		"Cmd-L" 		: "jump2Line",
		"Ctrl-L" 		: "jump2Line",
		"Cmd-O" 		: "showAllFunctions",
		"Ctrl-O" 		: "showAllFunctions",
		"Ctrl-Q"		: "toggleComment",
		"Cmd-Q"			: "toggleComment",
		"Ctrl-B"		: "removeTrailingSpaces"
	}
};







CodeMirror.commands.duplicateRowUp = function(editor) {
	CodeMirror.commands.duplicateRow(editor, true);
};

CodeMirror.commands.duplicateRowDown = function(editor) {
	CodeMirror.commands.duplicateRow(editor, false);
};

CodeMirror.commands.duplicateRow = function(editor, up) {
	var start = editor.getCursor("start");
	var end = editor.getCursor("end");
	var text = editor.getRange({line:start.line, ch:0}, {line:end.line});
	if(up) {
		if(end.line===editor.doc.lastLine()) {
			editor.replaceRange("\n"+text, {line:end.line});
			editor.setSelection(start, end);
		} else {
			editor.replaceRange(text+"\n", {line:end.line+1, ch:0});
		}
	} else {
		if(start.line===0) {
			editor.replaceRange(text+"\n", {line:0, ch:0});
		} else {
			editor.replaceRange("\n"+text, {line:start.line-1});
		}
	}
};

CodeMirror.commands.removeLines = function(editor) {
	var startLine = editor.getCursor("start").line;
	var endLine = editor.getCursor("end").line;
	var pos = editor.getCursor();
	editor.replaceRange("", {line:startLine,ch:0}, {line:endLine+1,ch:0});
	editor.setCursor(pos);
};

CodeMirror.commands.selectLines = function(editor) {
	var posStart = editor.getCursor("start");
	var posEnd = editor.getCursor("end");
	posStart.ch=0;
	posEnd.ch=editor.getLine(posEnd.line).length;
	editor.setSelection(posStart, posEnd);
};

CodeMirror.commands.tabWithAutoComplete = function(editor) {
	console.log("tabWithAutoComplete");
	var cur = editor.getCursor();

	var c = editor.getSearchCursor(/\s/);

	var match = c.matches(true, cur);
	console.log("match", match);
	var start;
	if(match) {
		start = match.to;
	} else {
		start = {line:cur.line, ch:0};
	}
	var text = editor.getRange(start, cur).trim();
	if(codemirrorSnippets[text]) {
		editor.replaceRange(codemirrorSnippets[text],start, cur);
	} else {
		//TODO: InsertSoftTab to use spaces
		editor.execCommand(editor.getSelection().length ? "indentMore" : "insertTab");
	}
};

CodeMirror.commands.shortcutSave = function(editor) {
	console.log("Ctrl/Cmd+s pressed", editor);
	XioCode.getActiveCodeEditor().saveFile();
};

CodeMirror.commands.newFile = function(editor) {
	//Does not work in chrome...
	console.log("Ctrl/Cmd+n pressed, new file...");
	unloadFile();
};

CodeMirror.commands.jump2Line = function(editor, line) {
	if(line===undefined) {
		XioPop.prompt({title:"Jump to line", text:"Enter the desired line number", onSubmit:function(lineNumber) {
			if(Number(lineNumber) > 0) {
				CodeMirror.commands.jump2Line(editor, Number(lineNumber)-1);
			}
		}});
		return;
	}
	editor.setCursor(line+100, 0);
	editor.setCursor(line-10, 0);
	editor.setCursor(line, 0);
	editor.focus();
}

CodeMirror.commands.removeTrailingSpaces = function(editor) {
	editor.doc.eachLine(function(line) {
		line.text = line.text.replace(/\s+$/,"");
   	});
	editor.refresh();
};

CodeMirror.commands.showAllFunctions = function(editor) {
	var functions = findFunctions();

	console.log(functions);

	XioPop.select({options:functions, onSubmit:function(f) {
		console.log("selected function", f)
		CodeMirror.commands.jump2Line(editor, f.line);
	}});
};
var XioCode = (function(){
	var
	FILE_STATE_LOADING = 20,
	FILE_STATE_READY = 30,
	FILE_STATE_SAVING = 40,

	PANE_CODE_EDITOR = 10,
	PANE_TODO = 20,
	PANE_FILE_BROWSER = 30,

	activeProjectId = null,
	activeCodeEditor = null,
	workspaceInitiated = false,
	panes = {},


	initWorkspace = function() {
		if(workspaceInitiated) return;

		panes = [
			{
				name: "CodeEditor1",
				type:PANE_CODE_EDITOR,
				codeEditor: new CodeEditor(document.getElementById("paneEditor1"))
			}
			/*,
			{
				name: "CodeEditor2",
				type:PANE_CODE_EDITOR,
				codeEditor: new CodeEditor(document.getElementById("paneEditor2"))
			}*/
		];
		activeCodeEditor = panes[0].codeEditor;
		workspaceInitiated = true;

	},


	getActiveProjectId = function() {
		return activeProjectId;
	},

	getPanes = function() {
		return panes;
	},

	getActiveCodeEditor = function() {
		return activeCodeEditor;
	},

	setActiveCodeEditor = function(ce) {
		activeCodeEditor = ce;
	},






	openProject = function(projectId) {
		activeProjectId = projectId;
		initWorkspace();
	};






	return {
		getActiveProjectId: getActiveProjectId,
		getActiveCodeEditor: getActiveCodeEditor,
		setActiveCodeEditor: setActiveCodeEditor,

		openProject: openProject,
		getPanes: getPanes
	}

}());
"use strict";

var DEBUG_MODE_ON=true;
var KEY_ENTER = 13;
var KEY_UP = 38;
var KEY_DOWN = 40;

if (!DEBUG_MODE_ON) {
    console = console || {};
    console.log = function(){};
}

var activeProject;
var pageTitle;
var title;
var hoverTimer;
var fileToBeLoaded;
var oldHash;

var username;
var h1, fileToolbar, projectToolbar, userMenu;


document.addEventListener("DOMContentLoaded", function(e) {

	XI.fire("DOMContentLoaded");

	console.log("CodeMirror" , CodeMirror.version, "loaded");

	GateKeeper.init(loginCallback, logoutCallback);
	Preview.init();

	pageTitle = document.title;
	title = document.getElementById("pageTitle");
	console.log("Init " + pageTitle);

	window.addEventListener("resize", fixLayout, false);
	window.addEventListener("hashchange", readHash, false);
	window.addEventListener("beforeunload", warnBeforeUnload);

	document.addEventListener("visibilitychange", function(e) {
		var date = new Date(e.timeStamp);
		console.debug(document.hidden ? "borta!" : "tillbaka!", date.toTimeString().substr(0,8));
	}, false);

	h1 = document.querySelector("#header h1");
	h1.addEventListener("click", function(){setHash()}, false);

	projectToolbar = document.querySelector("#projectToolbar");
	projectToolbar.addEventListener("click", projectToolbarHandler, false);

	fileToolbar = document.querySelector("#fileBrowser .toolbar");
	fileToolbar.addEventListener("click", fileToolbarHandler, false);

	userMenu = document.getElementById("userMenu");
	userMenu.addEventListener("click", userMenuHandler, false);
	username = document.getElementById("username");

	var dividers = document.querySelectorAll(".divider");
	for(var i=0; i<dividers.length; i++) {
		dividers[i].addEventListener("mousedown", startDivide, false);
	}

	if(_USER && _USER.username) {
		GateKeeper.setUser(_USER);
	} else {
		GateKeeper.showLogin();
	}
}, false);


function startDivide(e) {
	console.log("divider down");
	e.preventDefault();

	var subjectId = e.target.dataset.subject;
	var subject = document.getElementById(subjectId);
	if(!subject) return;

	document.addEventListener("mousemove", mouseMove);
	document.addEventListener("mouseup", mouseUp);
	var pos = e.target.dataset.subject_pos;

	function mouseMove(e) {
		var dx = (pos==="right")? -e.movementX : e.movementX;
		subject.style.width = (subject.offsetWidth+dx) + "px";
		console.log("move", subject, e);
	}

	function mouseUp() {
		document.removeEventListener("mousemove", mouseMove);
		document.removeEventListener("mouseup", mouseUp);
	}
}

function loginCallback(user) {
	document.body.classList.add("authorized");
	username.textContent = user.username;

    ProjectList.setOrderBy(user.projects_order_by, user.projects_order_dir);
	ProjectList.loadProjects();
	readHash();
}

function logoutCallback() {
	ProjectList.clear();
	FileList.clear();
	Todo.clear();

	for(var i=0; i<XioCode.getPanes().length; i++) {
		var pane = XioCode.getPanes()[i];
		if(pane.type === 10) {
			pane.codeEditor.clear()
		}
	}

	activeProject = null;
	oldHash = null;
}

function warnBeforeUnload(e) {
	var n = File.countDirtyFiles();
	console.log("dirty check", n);
	if(n>0) {
		var text = "You have "+n+" unsaved files. Are you sure you want to navigate away from this page";
		e.returnValue = text;
		return text;
	}
}



/***************** TOOLBAR **********************************************************************/

function projectToolbarHandler(e) {
	if(e.button!==0) return;
	if(projectToolbar.classList.contains("disabled")) return;
	if(!activeProject) return;

	var button = e.target;
	switch(button.dataset.action) {

		case "run":
		previewProject(activeProject.id);
		break;

		case "config":
		ProjectConfig.open(activeProject.id);
		break;

		case "export":
			window.location="/scripts/export_zip.php?path=" + activeProject.id + "/";
		break;

		default:
		console.warn("Unknown button clicked");
	}

}


function fileToolbarHandler(e) {
	if(e.button!==0) return false;

	var button = e.target;
	if(button.classList.contains("disabled")) return;

	switch(button.dataset.action) {

		case "new":
		XioCode.getActiveCodeEditor().newFile();
		break;

		case "reload":
		FileList.loadProjectFiles();
		break;

		default:
		console.warn("Unknown button clicked");
	}
}



/***************** USER MENU **********************************************************************/

function userMenuHandler(e) {
	console.log("click", e);
	if(e.button!==0) return false;

	var target = e.target;
	while(target.nodeName!=="LI") {
		if(target===userMenu) return;
		target = target.parentElement;
	}

	switch(target.dataset.action) {
		case "logout":
		GateKeeper.logout();
		break;

		case "exportAllZip":
		var d = new Date();
		window.location="/scripts/export_zip.php?path=" + "&filename=Projects_"+d.toISOString().substring(0,10)+'.zip';
		break;

		case "changePassword":
		XioPop.prompt({title:"Change password", text:"Enter your new password", onSubmit:function(newPass) {
			if(newPass) {
				var formData = new FormData();
				formData.append("newPass", newPass);
				var xhr = new XMLHttpRequest();
				xhr.open('POST', "/scripts/change_password.php", true);
				xhr.onload = function(e) {
					var xhr = e.target;
					if(xhr.status===200) {
						console.log("Sparat");
					} else {
						console.err("Error changing password", xhr);
					}
				};
				xhr.send(formData);
			}
		}});
		break;
	}
}


function fixLayout() {
	for(var i=0; i<XioCode.getPanes().length; i++) {
		var pane = XioCode.getPanes()[i];
		if(pane.type === 10) {
			var height = pane.codeEditor.elem.offsetHeight - 25;
			pane.codeEditor.editor.setSize(null, height);
		}
	}
	Preview.fixLayout();
}


function openProject(id) {
	console.log("Open project", id);

	FileList.clear();
	FileList.setProjectId(id);
	ProjectList.updateLastOpened(id);
	Todo.loadAll(id);

	activeProject = {'id':id};
	XioCode.openProject(id);

	//set active project if project is loaded
	if(ProjectList.getProject(id)) {
		activeProject = ProjectList.getProject(id);
		activeProject.id = id;
		document.title = pageTitle + " - " + activeProject.name;
		title.textContent = activeProject.name;
	}

	for(var i=0; i<XioCode.getPanes().length; i++) {
		var pane = XioCode.getPanes()[i];
		if(pane.type === 10) {
			pane.codeEditor.setProjectId(id);
		}
	}

	projectToolbar.classList.remove("disabled");

	document.getElementById("projectChooser").classList.add("hidden");
	document.getElementById("projectArea").classList.remove("hidden");
	fixLayout();
}


function previewProject(id) {
	var url = ProjectList.getProject(id).run_url;
	if(!url) {
		url = projectsURL + id + "/";
	}
	window.open(url, id+'_preview');
}


function createNewFile(path) {
	if(!path) path="";
	XioPop.prompt({title:"Enter the new filename", value:path, onSubmit:function(newFileName) {
		if(newFileName===false) {
			console.debug("abort file creation");
			return;
		} else if(newFileName.trim()==="") {
			console.debug("not a valid filename");
			XioPop.alert({title:"Invalid filename", text:"You must enter a valid filename, try again", onClose:function() {
				createNewFile();
			}});
		} else {
			Ajax.post2JSON("/scripts/file_handler.php", {action:"new", project_id:activeProject.id, uri:newFileName}, fileCreationCallback);
		}
	}});
}

function fileCreationCallback(json) {
	if(!json) return false;

	switch(json.status) {
		case STATUS_OK:
		console.log("file saved as ", json.uri);
		FileList.loadProjectFiles();
		XioCode.getActiveCodeEditor().openFile(json.uri);
		break;

		case STATUS_FILE_COLLISION:
		XioPop.confirm({title:"File already exists", text:"Are you sure you want to overwrite "+json.uri+"?", onSubmit:function(answer) {
			if(answer) {
				Ajax.post2JSON("/scripts/file_handler.php", {action:"new", project_id:activeProject.id, uri:newFileName, overwrite:true}, fileCreationCallback);
			}
		}});
		break;

		default:
		console.warn("handle callback", json);
	}
}


function renameFile(uri, newUri, overwrite) {
	var parameters = {
		'action':'rename',
		'project_id':activeProject.id,
		'uri':uri,
		'new_uri':newUri
	};
	if(overwrite===true) parameters['overwrite']=true;
	Ajax.post2JSON("/scripts/file_handler.php", parameters, renameCallback);
}

function renameCallback(json) {
	switch(json.status) {
		case STATUS_OK:

		console.log("File '%s' renamed to '%s'", json.uri, json.newUri);
		FileList.loadProjectFiles();

		var openedFile = File.getFileByUri(activeProject.id, json.uri);
		if(openedFile) {
			openedFile.rename(json.newUri);
		}
		break;

		case STATUS_FILE_COLLISION:
		XioPop.confirm({title:"File already exists", text:"Are you sure you want to overwrite "+json.newUri+"?", onSubmit:function(answer) {
			if(answer) {
				renameFile(json.uri, json.newUri, true);
			}
		}});
		break;

		default:
		console.warn("handle callback", json);
	}
}

function previewFile(uri) {
	var path = projectsURL + activeProject.id +"/"+ uri;
	console.log("Preview:", path);

	if(Preview.isVisible()) {
		Preview.load(path);
	} else {
		window.open(path, 'code_file_preview');
	}
}


function setHash(newHash) {
	if(!newHash) {
		history.pushState({foo: "bar"}, "kokooo", "/");
		readHash();
		oldHash = "";
	} else if(newHash!=oldHash) {
		window.location.hash = newHash;
		oldHash = newHash;
	}
}


function readHash() {
	var hash = window.location.hash;
	if(oldHash===hash) return;

	//console.log("Read hash", hash, window.location.hash);
	var match = hash.match(/^#([^\/]*)$/);
	if(match) {
		var projectId = match[1];

		if(!activeProject || (activeProject && projectId!=activeProject.id)) {
			openProject(projectId);
		}

	} else {
		console.log("Show projects page");
		chooseProject();
	}
	oldHash=hash;
}


function chooseProject() {
	projectToolbar.classList.add("disabled");
	document.getElementById("projectChooser").classList.remove("hidden");
	document.getElementById("projectArea").classList.add("hidden");

	title.textContent = "My projects";
	activeProject = null;
	document.title = pageTitle;
	txtProjectFilter.focus();
}


function getMimeByUri(uri) {
	var extension = /\.([^.]+)$/.exec(uri);
	if(!extension) return "";
	var info = CodeMirror.findModeByExtension(extension[1]);
	if(!info) {
		switch(extension[1]) {
			case "svg": return "xml";
		}
	}
	if(info.mime==="text/x-sql") return "text/x-sql";
	return info? info.mode : "";
}


function findFunctions() {
	console.log("Finding functions");

	var text = XioCode.getActiveCodeEditor().editor.getValue();

	var doc = XioCode.getActiveCodeEditor().editor.getDoc();
	var functions = [];
	var hit;

	// Find functions in the format:   function pelle(arg1, arg2) {
	var re = new RegExp("function\\s+([A-Z0-9_]+)\\s*\\(([^\\)]*)\\)", "gmi");
	while(hit = re.exec(text)) {
		var pos = doc.posFromIndex(hit.index);
		var argus = hit[2].replace(" ","").split(",");
		functions.push({text:hit[1], name:hit[1], args:argus, index:hit.index, line:pos.line, char:pos.char});
	}

	// Find functions in the format:   pelle = function(arg1, arg2) {   or   pelle: function(arg1, arg2)
	re = new RegExp("([A-Z0-9_\.]+)\\s*[=:]\\s*function\\s*\\(([^\\)]*)\\)", "gmi");
	while(hit = re.exec(text)) {
		var pos = doc.posFromIndex(hit.index);
		var argus = hit[2].replace(" ","").split(",");
        functions.push({text:hit[1], name:hit[1], args:argus, index:hit.index, line:pos.line, char:pos.char});
	}

	function compare(a,b) {
		if (a.name < b.name) return -1;
		if (a.name > b.name) return 1;
		return 0;
	}

	functions.sort(compare);
	return functions;
}


function toHumanReadableFileSize(bytes, si) {
	var unit = si ? 1000 : 1024;
    if (bytes < unit) return bytes + " bytes";
    var exp = Math.floor(Math.log(bytes) / Math.log(unit));
    var pre = (si ? "kMGTPE" : "KMGTPE").charAt(exp-1) + (si ? "" : "i");
	var val = bytes/Math.pow(unit, exp);
    return val.toFixed(1) + " " + pre + "B";
}


function toHumanReadableDateTime(ts) {
	if(!ts) return "";
	var ts = new Date(ts);
	var now = new Date();
	var time = ts.toTimeString().substr(0,5);
	var date = ts.toISOString().substr(0,10);

	var diff = ts - now;
	var yesterday = new Date();
	yesterday.setDate(yesterday.getDate() - 1);

	if(diff<24*60*60*1000 && now.getDate()===ts.getDate()) {
		return "Today " + time;
	} else if(diff<2*24*60*60*1000 && yesterday.getDate()===ts.getDate()) {
		return "Yesterday " + time;
	}
	return date + " " + time;
}


function isNumeric(n) {
	return !isNaN(parseFloat(n)) && isFinite(n);
}


function clone(obj) {
    if (null == obj || "object" != typeof obj) return obj;
    var copy = obj.constructor();
    for (var attr in obj) {
        if (obj.hasOwnProperty(attr)) copy[attr] = obj[attr];
    }
    return copy;
}
