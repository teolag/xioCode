/*! xiocode 2015-07-18 21:56:56 */

"use strict";function startDivide(a){function b(a){var b="right"===f?-a.movementX:a.movementX;e.style.width=e.offsetWidth+b+"px",console.log("move",e,a)}function c(){document.removeEventListener("mousemove",b),document.removeEventListener("mouseup",c)}console.log("divider down"),a.preventDefault();var d=a.target.dataset.subject,e=document.getElementById(d);if(e){document.addEventListener("mousemove",b),document.addEventListener("mouseup",c);var f=a.target.dataset.subject_pos}}function loginCallback(a){document.body.classList.add("authorized"),username.textContent=a.username,ProjectList.setOrderBy(a.projects_order_by,a.projects_order_dir),ProjectList.loadProjects(),readHash()}function logoutCallback(){ProjectList.clear(),FileList.clear(),Todo.clear();for(var a=0;a<XioCode.getPanes().length;a++){var b=XioCode.getPanes()[a];10===b.type&&b.codeEditor.clear()}activeProject=null,activeFile=null,oldHash=null,xioDocs={}}function warnBeforeUnload(a){var b=File.countDirtyFiles();if(console.log("dirty check",b),b>0){var c="You have "+b+" unsaved files. Are you sure you want to navigate away from this page";return a.returnValue=c,c}}function projectToolbarHandler(a){if(0===a.button&&!projectToolbar.classList.contains("disabled")&&activeProject){var b=a.target;switch(b.dataset.action){case"run":previewProject(activeProject.id);break;case"config":ProjectConfig.open(activeProject.id);break;case"export":window.location="/scripts/export_zip.php?path="+activeProject.id+"/";break;default:console.warn("Unknown button clicked")}}}function fileToolbarHandler(a){if(0!==a.button)return!1;var b=a.target;if(!b.classList.contains("disabled"))switch(b.dataset.action){case"new":XioCode.getActiveCodeEditor().newFile();break;case"reload":FileList.loadProjectFiles();break;default:console.warn("Unknown button clicked")}}function userMenuHandler(a){if(console.log("click",a),0!==a.button)return!1;for(var b=a.target;"LI"!==b.nodeName;){if(b===userMenu)return;b=b.parentElement}switch(b.dataset.action){case"logout":GateKeeper.logout();break;case"exportAllZip":var c=new Date;window.location="/scripts/export_zip.php?path=&filename=Projects_"+c.toISOString().substring(0,10)+".zip";break;case"changePassword":XioPop.prompt({title:"Change password",text:"Enter your new password",onSubmit:function(a){if(a){var b=new FormData;b.append("newPass",a);var c=new XMLHttpRequest;c.open("POST","/scripts/change_password.php",!0),c.onload=function(a){var b=a.target;200===b.status?console.log("Sparat"):console.err("Error changing password",b)},c.send(b)}}})}}function fixLayout(){for(var a=0;a<XioCode.getPanes().length;a++){var b=XioCode.getPanes()[a];if(10===b.type){var c=b.codeEditor.elem.offsetHeight-25;b.codeEditor.editor.setSize(null,c)}}Preview.fixLayout()}function openProject(a){console.log("Open project",a),FileList.clear(),FileList.setProjectId(a),ProjectList.updateLastOpened(a),Todo.loadAll(a),activeProject={id:a},XioCode.openProject(a),ProjectList.getProject(a)&&(activeProject=ProjectList.getProject(a),activeProject.id=a,document.title=pageTitle+" - "+activeProject.name,title.textContent=activeProject.name);for(var b=0;b<XioCode.getPanes().length;b++){var c=XioCode.getPanes()[b];10===c.type&&c.codeEditor.setProjectId(a)}projectToolbar.classList.remove("disabled"),document.getElementById("projectChooser").classList.add("hidden"),document.getElementById("projectArea").classList.remove("hidden"),fixLayout()}function previewProject(a){var b=ProjectList.getProject(a).run_url;b||(b=projectsURL+a+"/"),window.open(b,a+"_preview")}function createNewFile(a){a||(a=""),XioPop.prompt({title:"Enter the new filename",value:a,onSubmit:function(a){return a===!1?void console.debug("abort file creation"):void(""===a.trim()?(console.debug("not a valid filename"),XioPop.alert({title:"Invalid filename",text:"You must enter a valid filename, try again",onClose:function(){createNewFile()}})):Ajax.post2JSON("/scripts/file_handler.php",{action:"new",project_id:activeProject.id,uri:a},fileCreationCallback))}})}function fileCreationCallback(a){if(!a)return!1;switch(a.status){case STATUS_OK:console.log("file saved as ",a.uri),FileList.loadProjectFiles(),XioCode.getActiveCodeEditor().openFile(a.uri);break;case STATUS_FILE_COLLISION:XioPop.confirm({title:"File already exists",text:"Are you sure you want to overwrite "+a.uri+"?",onSubmit:function(a){a&&Ajax.post2JSON("/scripts/file_handler.php",{action:"new",project_id:activeProject.id,uri:newFileName,overwrite:!0},fileCreationCallback)}});break;default:console.warn("handle callback",a)}}function renameFile(a,b,c){var d={action:"rename",project_id:activeProject.id,uri:a,new_uri:b};c===!0&&(d.overwrite=!0),Ajax.post2JSON("/scripts/file_handler.php",d,renameCallback)}function renameCallback(a){switch(a.status){case STATUS_OK:console.log("File '%s' renamed to '%s'",a.uri,a.newUri),FileList.loadProjectFiles();var b=File.getFileByUri(activeProject.id,a.uri);b&&b.rename(a.newUri);break;case STATUS_FILE_COLLISION:XioPop.confirm({title:"File already exists",text:"Are you sure you want to overwrite "+a.newUri+"?",onSubmit:function(b){b&&renameFile(a.uri,a.newUri,!0)}});break;default:console.warn("handle callback",a)}}function previewFile(a){var b=projectsURL+activeProject.id+"/"+a;console.log("Preview:",b),Preview.isVisible()?Preview.load(b):window.open(b,"code_file_preview")}function setHash(a){a?a!=oldHash&&(window.location.hash=a,oldHash=a):(history.pushState({foo:"bar"},"kokooo","/"),readHash(),oldHash="")}function readHash(){var a=window.location.hash;if(oldHash!==a){var b=a.match(/^#([^\/]*)$/);if(b){var c=b[1];(!activeProject||activeProject&&c!=activeProject.id)&&openProject(c)}else console.log("Show projects page"),chooseProject();oldHash=a}}function chooseProject(){projectToolbar.classList.add("disabled"),document.getElementById("projectChooser").classList.remove("hidden"),document.getElementById("projectArea").classList.add("hidden"),title.textContent="My projects",activeProject=null,document.title=pageTitle,txtProjectFilter.focus()}function getMimeByUri(a){var b=/\.([^.]+)$/.exec(a);if(!b)return"";var c=CodeMirror.findModeByExtension(b[1]);if(!c)switch(b[1]){case"svg":return"xml"}return"text/x-sql"===c.mime?"text/x-sql":c?c.mode:""}function findFunctions(){function a(a,b){return a.name<b.name?-1:a.name>b.name?1:0}console.log("Finding functions");for(var b,c=XioCode.getActiveCodeEditor().editor.getValue(),d=XioCode.getActiveCodeEditor().editor.getDoc(),e=[],f=new RegExp("function\\s+([A-Z0-9_]+)\\s*\\(([^\\)]*)\\)","gmi");b=f.exec(c);){var g=d.posFromIndex(b.index),h=b[2].replace(" ","").split(",");e.push({text:b[1],name:b[1],args:h,index:b.index,line:g.line,"char":g["char"]})}for(f=new RegExp("([A-Z0-9_.]+)\\s*[=:]\\s*function\\s*\\(([^\\)]*)\\)","gmi");b=f.exec(c);){var g=d.posFromIndex(b.index),h=b[2].replace(" ","").split(",");e.push({text:b[1],name:b[1],args:h,index:b.index,line:g.line,"char":g["char"]})}return e.sort(a),e}function toHumanReadableFileSize(a,b){var c=b?1e3:1024;if(c>a)return a+" bytes";var d=Math.floor(Math.log(a)/Math.log(c)),e=(b?"kMGTPE":"KMGTPE").charAt(d-1)+(b?"":"i"),f=a/Math.pow(c,d);return f.toFixed(1)+" "+e+"B"}function toHumanReadableDateTime(a){if(!a)return"";var a=new Date(a),b=new Date,c=a.toTimeString().substr(0,5),d=a.toISOString().substr(0,10),e=a-b,f=new Date;return f.setDate(f.getDate()-1),864e5>e&&b.getDate()===a.getDate()?"Today "+c:1728e5>e&&f.getDate()===a.getDate()?"Yesterday "+c:d+" "+c}function isNumeric(a){return!isNaN(parseFloat(a))&&isFinite(a)}function clone(a){if(null==a||"object"!=typeof a)return a;var b=a.constructor();for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b}function TabBar(a,b){this.tabList=a,this.codeEditor=b,this.tabs=[]}var XI=function(){var a={},b=[],c=function(b){a[b]=!0,e(b)},d=function(b){delete a[b]},e=function(a){for(var c=b.length;c--;)h(b[c],a)&&(b[c].callback(),b[c].keep||b.splice(c,1))},f=function(a,c,d){Array.isArray(a)||(a=[a]);var e={conditions:a,callback:c,keep:d};return h(e)?(e.callback(),!0):(b.push(e),e)},g=function(a){var c=b.indexOf(a);-1!==c&&b.splice(c,1)},h=function(b,c){var d=b.conditions;if(-1===d.indexOf(c))return!1;for(var e=!0,f=0;f<d.length;f++){var g=d[f];if(!a.hasOwnProperty(g)){e=!1;break}}return e};return{listen:f,stopListen:g,fire:c,reset:d}}();!function(){var a=0,b={},c="untitled",d=self.File=function(c){this.id=a++,this.uri=null,this.projectId=null,this.doc=null,this.state=d.STATE_EMPTY,this.filename=null,this.codeEditor=c,this.tab=null,b[this.id]=this};d.STATE_EMPTY=0,d.STATE_LOADING=20,d.STATE_READY=30,d.STATE_SAVING=40,d.STATE_DIRTY=50,d.STATE_UNSAVED=60,d.prototype={blank:function(a){this.filename=c,this.uri=this.filename,this.projectId=a,this.doc=CodeMirror.Doc("","")},load:function(a,b,c){this.state=d.STATE_LOADING,this.uri=b,this.filename=e(b),this.projectId=a,this.doc=CodeMirror.Doc("","");var f={action:"load",project_id:a,uri:encodeURI(b)};Ajax.getJSON("/scripts/file_handler.php",f,h.bind(this,c))},save:function(a,b){this.state=d.STATE_SAVING;var c=new FormData;c.append("uri",this.uri),c.append("project_id",this.projectId),c.append("code",a),c.append("action","save"),console.log("Save file '"+this.uri+"'..."),Ajax.post2JSON("/scripts/file_handler.php",c,f.bind(this,b))},saveAs:function(a,b,c,e){this.state=d.STATE_SAVING;var f=new FormData;f.append("uri",a),f.append("project_id",this.projectId),f.append("code",b),f.append("action","saveAs"),c&&f.append("overwrite",!0),Ajax.post2JSON("/scripts/file_handler.php",f,g.bind(this,e))},close:function(a){if(this.doc.isClean()||a)this.codeEditor.closeFile(this),a&&(this.doc.markClean(),this.codeEditor.updateFileStatus(this)),delete b[this.id];else{var c=this;XioPop.confirm({title:"Unsaved file",text:"This file has unsaved data, close anyway?",onSubmit:function(a){a&&c.close(!0)}})}},rename:function(a){this.uri=a,this.filename=e(a),this.tab.updateFromFile()},setTab:function(a){this.tab=a}},d.getFileById=function(a){return b.hasOwnProperty(a)?b[a]:void 0},d.getFileByUri=function(a,c){for(var d in b)if(b.hasOwnProperty(d)){var e=b[d];if(e.projectId===a&&e.uri===c)return e}},d.getProjectFiles=function(a){var c={};for(var d in b)if(b.hasOwnProperty(d)){var e=b[d];e.projectId===a&&(c[d]=e)}return c},d.countDirtyFiles=function(){var a=0;for(var c in b)if(b.hasOwnProperty(c)){var d=b[c];d.doc.isClean()||a++}return a};var e=function(a){return a.replace(/^.*[\\\/]/,"")},f=function(a,b){switch(b.status){case STATUS_OK:this.doc.markClean(),this.state=d.STATE_READY,a&&a(this);break;case STATUS_FILE_COULD_NOT_UPDATE:XioPop.alert({title:"Permission denied",text:"You do not have sufficient permission to update the file"}),this.state=d.STATE_DIRTY;break;default:XioPop.alert({title:"Error",text:"Unknown error while saving file"})}},g=function(a,b){b.status===STATUS_OK&&(this.doc.markClean(),this.state=d.STATE_READY,this.uri=b.uri,this.filename=e(b.uri),this.projectId=b.projectId),a&&a(this,b)},h=function(a,b){return b.status!==STATUS_OK?void console.warn("Error "+b.status+": "+b.message):(this.doc=CodeMirror.Doc(b.text,getMimeByUri(b.uri)),this.state=d.STATE_READY,void(a&&a(this)))}}();var DEBUG_MODE_ON=!0,KEY_ENTER=13,KEY_UP=38,KEY_DOWN=40;DEBUG_MODE_ON||(console=console||{},console.log=function(){});var activeProject,pageTitle,title,hoverTimer,fileToBeLoaded,oldHash,username,h1,fileToolbar,projectToolbar,userMenu;document.addEventListener("DOMContentLoaded",function(a){XI.fire("DOMContentLoaded"),console.log("CodeMirror",CodeMirror.version,"loaded"),GateKeeper.init(loginCallback,logoutCallback),Preview.init(),pageTitle=document.title,title=document.getElementById("pageTitle"),console.log("Init "+pageTitle),window.addEventListener("resize",fixLayout,!1),window.addEventListener("hashchange",readHash,!1),window.addEventListener("beforeunload",warnBeforeUnload),document.addEventListener("visibilitychange",function(a){var b=new Date(a.timeStamp);console.debug(document.hidden?"borta!":"tillbaka!",b.toTimeString().substr(0,8))},!1),h1=document.querySelector("#header h1"),h1.addEventListener("click",function(){setHash()},!1),projectToolbar=document.querySelector("#projectToolbar"),projectToolbar.addEventListener("click",projectToolbarHandler,!1),fileToolbar=document.querySelector("#fileBrowser .toolbar"),fileToolbar.addEventListener("click",fileToolbarHandler,!1),userMenu=document.getElementById("userMenu"),userMenu.addEventListener("click",userMenuHandler,!1),username=document.getElementById("username");for(var b=document.querySelectorAll(".divider"),c=0;c<b.length;c++)b[c].addEventListener("mousedown",startDivide,!1);_USER&&_USER.username?GateKeeper.setUser(_USER):GateKeeper.showLogin()},!1);var FileList=function(){function a(a){a.querySelector("svg");a.classList.contains("open")?c(a):b(a)}function b(a){var b=a.dataset.uri,c=l.indexOf(b);-1===c&&l.push(b),a.classList.add("open");var d=a.querySelector("ul");d.style.display="block"}function c(a){var b=a.dataset.uri,c=l.indexOf(b);c>-1&&l.splice(c,1),a.classList.remove("open");var d=a.querySelector("ul");d.style.display="none"}function d(a,b,c){console.log("start upload:",a,"to",b);var d=new FormData;d.append("path",b),d.append("project_id",activeProject.id);for(var e,f=0,g=0;g<a.length;++g){var h=a[g],i=new FormData;if(i.append("file",b+h.name),i.append("project_id",activeProject.id),e=new XMLHttpRequest,e.open("POST","/scripts/check_collision.php",!1),e.send(i),409===e.status){if(!confirm(e.responseText+", Do you want to overwrite the file?"))continue}else if(202!==e.status)continue;d.append(h.name,h),f++}f>0&&(e=new XMLHttpRequest,e.open("POST","/scripts/file_upload.php",!0),e.onload=function(b){200===e.status?FileList.loadProjectFiles():(console.log("Error uploading file:"),console.log(a))},e.upload.onprogress=function(a){},e.send(d))}function e(a,b){k.classList.remove("hidden");var c=b.pageY;c+k.offsetHeight+10>window.innerHeight&&(c=window.innerHeight-k.offsetHeight-10),k.dataset.uri=a,k.style.top=c+"px",k.style.left=b.pageX+"px"}function f(a,b){e(a,b),k.classList.add("root")}function g(){k.classList.add("hidden"),k.classList.remove("root");for(var a=j.getElementsByClassName("rightClicked"),b=0;b<a.length;b++)a[b].classList.remove("rightClicked")}var h,i,j,k,l=[],m=function(){k=document.getElementById("fileListRightClickMenu"),k.addEventListener("click",B,!1),j=document.getElementById("fileList"),j.addEventListener("drop",z,!1),j.addEventListener("dragover",A,!1),j.addEventListener("dragleave",A,!1),j.addEventListener("dragstart",y,!1),j.addEventListener("contextmenu",t,!1),j.addEventListener("click",t,!1),j.addEventListener("dblclick",t,!1)},n=function(a){j||m(),h=a,console.debug("FileList: ProjectId set to "+a),o()},o=function(){Ajax.getJSON("/scripts/get_project_files.php",{project_id:h},function(a){i={},j.innerHTML=p(a,"");for(var c=0;c<l.length;c++){var d=j.querySelector("li[data-uri='"+l[c]+"']");d&&b(d)}},function(a){403===a.status&&(console.log("Access denied. You must login again to load the files"),showLogin()),console.error("Error loading file tree",a)})},p=function(a,b){var c=[];c.push("<ul>");for(var d=0;d<a.length;d++){var e=a[d],f=e.filename+"\n",g="";("jpg"===e.type||"jpeg"===e.type||"gif"===e.type||"png"===e.type||"bmp"===e.type||"tif"===e.type||"tiff"===e.type)&&(g=" imagePreview",f+=e.width+" x "+e.height+"\n");var h=e.path+e.filename;i[h]=e;var j="",k="xiocode.properties"===e.filename||"xiocode.todo"===e.filename?" hidden":"";f+=e.size?toHumanReadableFileSize(e.size,!0):e.leafs?e.leafs.length+" items":"empty",c.push("<li draggable='true' class='"+g+j+k+"' data-uri='"+h+"' data-type='"+e.type+"' data-mime='"+e.mime+"' title='"+f+"'>"),c.push("<div class='file'>"),c.push("<svg class='icon "+e.icon+"'><use xlink:href='/icons.svg#icon-"+e.icon+"' /></svg>"),e.leafs&&c.push("<svg class='icon "+e.icon+" open'><use xlink:href='/icons.svg#icon-"+e.icon+"-open' /></svg>"),c.push("<div class='filename'>"+e.filename+"</div></div>"),e.leafs&&c.push(p(e.leafs,e.path)),c.push("</li>")}return c.push("</ul>"),c.join("")},q=function(a){r(),console.log("Select: '"+a+"' in fileList");var c=j.querySelector("li[data-uri='"+a+"']");if(c){c.classList.add("selected");for(var d=c.parentElement;d!=j;)"LI"===d.nodeName&&b(d),d=d.parentElement}},r=function(a){for(var b=j.querySelectorAll("li"),c=0;c<b.length;c++)b[c].classList.remove("selected")},s=function(){j||m(),i=null,j.innerHTML="Loading..."},t=function(b){for(var c=b.target;"LI"!==c.nodeName&&c!==j;)c=c.parentElement;if(g(),0===b.button){if(c!==j){var d=c.dataset.uri,k=i[d];"folder"===k.type?a(c):"dblclick"===b.type?-1!=["zip","tar","rar","psd","xsl","doc","xslx","docx"].indexOf(k.type)?(console.log("Download file..."),window.location.href="/scripts/file_handler.php?action=download&project_id="+h+"&uri="+d):-1!=["jpg","png","pdf","gif","bmp"].indexOf(k.type)?(console.log("Open preview in new tab"),window.open(projectsURL+h+"/"+d)):(console.log("Open file",d),XioCode.getActiveCodeEditor().openFile(d)):q(d),b.stopPropagation()}}else if(2===b.button){if(b.ctrlKey||b.altKey)return!0;if(c===j)f("",b);else{var d=c.dataset.uri;c.classList.add("rightClicked"),e(d,b)}b.preventDefault()}},u=function(a){var b=j.querySelector("li[data-uri='"+a+"']");if(b){var c=document.createElement("span");c.classList.add("spinner","icon-spinner"),b.appendChild(c)}},v=function(a){var b=j.querySelector("li[data-uri='"+a+"'] span.spinner");b&&b.parentElement.removeChild(b)},w=function(a){var b=j.querySelector("li[data-uri='"+a+"']");b&&b.classList.remove("changed")},x=function(a){var b=j.querySelector("li[data-uri='"+a+"']");b&&b.classList.add("changed")},y=function(a){for(var b=a.target;"LI"!==b.nodeName;)if(b=b.parentElement,b===j)return;var c=b.dataset.uri,d=i[c],e="css/text",f=location.origin+"/scripts/file_handler.php?action=load_raw&project_id="+h+"&uri="+encodeURI(c),g=e+":"+d.filename+":"+f;a.dataTransfer.setData("DownloadURL",g),a.dataTransfer.setData("uri",c),a.stopPropagation()},z=function(a){A(a);for(var b=a.target;b!==j&&("LI"!==b.nodeName||"folder"!==b.dataset.type);)b=b.parentElement;if(b===j)var c="";else var c=b.dataset.uri+"/";var e=a.dataTransfer.getData("uri");if(e){var f=c+i[e].filename;f===e?console.log("drop to same place, abort"):Ajax.post2JSON("/scripts/file_handler.php",{action:"rename",project_id:h,uri:e,new_uri:f},function(a){FileList.loadProjectFiles()})}else{var g=a.target.files||a.dataTransfer.files;if(console.log("upload files:",g),g.length>0)return void d(g,c,!1)}},A=function(a){a.preventDefault();for(var b=a.target;b!==j&&("LI"!==b.nodeName||"folder"!==b.dataset.type);)b=b.parentElement;"dragover"===a.type?b.classList.add("dropTo"):b.classList.remove("dropTo")},B=function(a){var b=a.target,c=k.dataset.uri,d=c?i[c].path:"",e=c?i[c].filename:"",f=c?"folder"===i[c].type:!1;switch(b.dataset["do"]){case"newFolder":XioPop.prompt({title:"New folder",text:"Enter the name of the folder",onSubmit:function(a){a&&(f&&(d+=e+"/"),Ajax.get("/scripts/create_folder.php",{project_id:h,uri:encodeURI(d+a)},function(){FileList.loadProjectFiles()}))}});break;case"newFile":f&&(d+=e+"/"),createNewFile(d);break;case"saveAs":XioPop.prompt({title:"Save as",text:"Enter the new name of the file/folder",value:e,onSubmit:function(a){a&&saveFileAs(a,!1)}});break;case"refresh":FileList.loadProjectFiles();break;case"delete":if(f)var j="Delete folder",l="Are you sure you want to delete the folder '"+c+"' and all of its content?";else var j="Delete file",l="Are you sure you want to delete the file: '"+c+"'?";XioPop.confirm({title:j,text:l,onSubmit:function(a){a&&Ajax.post2JSON("/scripts/file_handler.php",{action:"delete",project_id:activeProject.id,uri:c},function(a){FileList.loadProjectFiles();for(var b=0;b<XioCode.getPanes().length;b++){var c=XioCode.getPanes()[b];if(10===c.type){var d=File.getFileByUri(h,a.uri);d&&d.close()}}})}});break;case"rename":XioPop.prompt({title:"Rename file",text:"Enter the new name of the file/folder",value:e,onSubmit:function(a){a&&renameFile(c,d+a)}});break;case"export":window.location.href="/scripts/file_handler.php?action=download&project_id="+h+"&uri="+c;break;case"upload":XioPop.alert({title:"upload file...",text:"not implemented yet "});break;case"preview":previewFile(c)}g()},C=function(){return i},D=function(){j.style.display="none"},E=function(){j.style.display="block"};return{loadProjectFiles:o,setProjectId:n,clear:s,showSpinner:u,hideSpinner:v,getFiles:C,setFileAsClean:w,setFileAsDirty:x,hide:D,show:E,selectFile:q,deselectAll:r}}(),GateKeeper=function(){var a,b,c,d,e,f,g,h,i,j,k=3e5,l=function(a,g){h=a,i=g,b=document.getElementById("login"),c=document.getElementById("loginForm"),c.addEventListener("submit",m,!1),d=document.getElementById("btnLogin"),e=c.elements.code_username,f=c.elements.code_password,j=document.getElementById("btnGoogleLogin"),j.addEventListener("click",t,!1)},m=function(a){a.preventDefault(),e.value&&f.value&&(d.disabled=!0,d.textContent="Authorizing...",Ajax.post2JSON("/scripts/gatekeeper.php?action=login",c,n))},n=function(f){f.status===STATUS_OK?(a=f.user,o()):(console.warn("Incorrect login or password"),b.className="",setTimeout(function(){b.classList.add("shake")},1)),c.reset(),d.disabled=!1,d.textContent="Login",e.focus()},o=function(){console.log("Welcome",a.username),g=setInterval(r,k),h&&h(a)},p=function(){Ajax.post("/scripts/gatekeeper.php?action=logout"),clearInterval(g),i&&i(),q()},q=function(){document.body.classList.remove("authorized"),document.title=pageTitle+" - Login",c.reset(),d.disabled=!1,d.textContent="Login",e.focus()},r=function(){console.log((new Date).toTimeString().substr(0,5),"Access check"),Ajax.getJSON("/scripts/gatekeeper.php",{action:"check",user_id:a.user_id},function(a){a.status!==STATUS_OK&&(console.warn(a.message),console.debug("Force logout"),p())})},s=function(b){a=b,o()},t=function(a){var b=a.target.dataset.url,c="Google login",d=500,e=600,f=screen.width/2-d/2,g=screen.height/2-e/2,h="toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=no, resizable=no, copyhistory=no, width="+d+", height="+e+", top="+g+", left="+f;window.open(b,c,h)},u=function(a){s(a.user)};return{init:l,showLogin:q,logout:p,setUser:s,googleLoginCallback:u}}(),Preview=function(){var a,b,c=!1,d=!1,e=function(){console.log("Init preview"),a=document.getElementById("preview"),b=document.getElementById("previewFrame"),window.addEventListener("resize",l,!1),g()},f=function(){c=!0,a.style.display="flex",l()},g=function(){c=!1,a.style.display="none"},h=function(a){b.src=a},i=function(){c&&(console.log("Refresh preview",b.src),"blank"!==b.src&&(b.src=b.src))},j=function(){return c},k=function(){return c&&d},l=function(){c&&(b.style.height=a.offsetHeight-15+"px")};return{init:e,fixLayout:l,show:f,hide:g,load:h,refresh:i,isVisible:j,doRefreshOnSave:k}}(),ProjectConfig=function(){var a,b,c,d,e,f=function(a){e=XioPop.load({url:"/scripts/project_config.php?project_id="+a,onLoad:g})},g=function(e){a=document.getElementById("frmProjectConfig"),a.addEventListener("submit",h,!1),b=document.getElementById("btnConfigCancel"),b.addEventListener("click",l,!1),c=document.getElementById("confTags"),c.addEventListener("keypress",j,!1),d=document.getElementById("listTags"),d.addEventListener("click",j,!1),k()},h=function(b){b.preventDefault(),console.log("Save project configurations..."),Ajax.post2JSON("/scripts/project_config.php?action=save",a,i)},i=function(a){switch(a.status){case STATUS_OK:console.log("Project configurations saved!"),l(),ProjectList.loadProjects();break;case STATUS_FILE_COULD_NOT_UPDATE:XioPop.alert({title:"Permission denied",text:"You do not have sufficient permission to update project config file"});break;default:XioPop.alert({title:"Error",text:"Unknown error while saving project config"})}},j=function(b){if("keypress"===b.type&&b.keyCode===KEY_ENTER){b.preventDefault();var c=b.target.value.trim();if(c){console.log("add tag");var d=document.createElement("input");d.type="hidden",d.value=c,d.name="config[tags][]",a.appendChild(d),k(),b.target.value=""}}else"click"===b.type&&"LI"===b.target.nodeName&&(console.log("input[value='"+b.target.textContent+"']"),a.removeChild(a.querySelector("input[value='"+b.target.textContent+"']")),k())},k=function(){var b=a.querySelectorAll("input[name='config[tags][]']");if(d.innerHTML="",b){console.log("taggar",b);for(var c=0;c<b.length;c++){var e=b[c].value,f=document.createElement("LI");f.textContent=e,d.appendChild(f)}}},l=function(a){e.close()};return{open:f}}(),ProjectList=function(){function a(a){if(c){var b=f.value.toLowerCase();if(b!==d){d=b,console.log("filter projects '"+b+"'",f,c);for(var g in c)if(c.hasOwnProperty(g)){var h=c[g],i=e.querySelector(".project[data-project_id='"+g+"']");-1!=h.name.toLowerCase().search(b)?i.classList.remove("hidden"):i.classList.add("hidden")}var j=e.querySelector(".selected");if(!j||j.classList.contains("hidden")){var k=w(!0);k||w()}}}}function b(a){return a.sort(function(a,b){var d=c[a],e=c[b];switch(k){case"name":var f=d.name.toLowerCase(),g=e.name.toLowerCase();return g>f?-1:f>g?1:0;case"created":var h=d.created||0,i=e.created||0;return i-h;case"opened":var h=d.last_opened||0,i=e.last_opened||0;return i-h}}),"desc"===l&&a.reverse(),a}var c,d,e,f,g,h,i,j,k="name",l="asc";XI.listen("DOMContentLoaded",function(b){console.log("Init ProjectList"),e=document.getElementById("projectList"),e.addEventListener("click",s,!1),e.addEventListener("mouseover",t,!1),e.addEventListener("drop",x,!1),e.addEventListener("dragover",x,!1),e.addEventListener("dragleave",x,!1),f=document.getElementById("txtProjectFilter"),f.addEventListener("search",a),f.addEventListener("keydown",v),f.addEventListener("keyup",a),g=document.getElementById("btnNewProject"),g.addEventListener("click",y,!1),j=document.getElementById("listProjectTags"),h=document.getElementById("listProjectOrderBy"),h.addEventListener("change",n,!1)});var m=function(){Ajax.getJSON("/scripts/get_projects.php",null,function(a){c=a,console.log("%i projects loaded",Object.keys(c).length),p(),XI.fire("projectsLoaded")})};XI.listen(["projectsLoaded","DOMContentLoaded","orderProjects"],function(){if(r(),a(),activeProject){var b=activeProject.id;activeProject=c[b],activeProject.id=b,document.title=pageTitle+" - "+activeProject.name,title.textContent=activeProject.name}},!0);var n=function(a){var b=a.target.selectedOptions[0];o(b.dataset.order,b.dataset.order_dir),Ajax.post("/scripts/save_user_settings.php",{projects_order_by:k,projects_order_dir:l},function(a){console.log("User settings callback",a)})},o=function(a,b){if(k!==a||l!==b){k=a,l=b;var c=h.querySelector("option[data-order='"+k+"'][data-order_dir='"+l+"']");c&&(c.selected="true"),XI.fire("orderProjects")}},p=function(){i=[];for(var a in c)if(c.hasOwnProperty(a)){var b=c[a].tags;b&&b.forEach(function(a,b){-1===i.indexOf(a)&&i.push(a)})}},q=function(){j.innerHTML="",i.forEach(function(a,b){var c=document.createElement("LI");c.textContent=a,j.appendChild(c)})},r=function(){var a=e.querySelector(".selected"),f=Object.keys(c);f=b(f,k);var g=document.createElement("ul");if(f.forEach(function(a,b){var d=c[a],e=document.getElementById("tplProjectListItem").content,f=e.querySelector("li");f.dataset.project_id=a;var h=e.querySelector(".name");h.textContent=d.name;var i=e.querySelector(".description");i.textContent=d.description||"";var j=document.importNode(e,!0);g.appendChild(j)}),e.innerHTML="",e.appendChild(g),a){var h=a.dataset.project_id;e.querySelector("li[data-project_id="+h+"]").classList.add("selected")}d="",q()},s=function(a){var b,d=a.target;"LI"===d.nodeName&&(b=d.dataset.action,console.log("Do",b),a.preventDefault());for(var f=d;!f.classList.contains("project");){if(f===e)return;f=f.parentElement}var g=f.dataset.project_id;switch(b){case"delete":var h=c[g];XioPop.confirm({title:"Delete project?",text:"Are you sure you want to delete project '"+h.name+"'?",onSubmit:function(a){if(a){var b=new FormData;b.append("project_id",g);var c=new XMLHttpRequest;c.open("POST","/scripts/delete_project.php",!0),c.onload=function(a){var b=a.target;200===b.status?(console.log("Project deleted"),m()):console.err("Error deleting project",b)},c.send(b)}else console.debug("Delete aborted")}});break;case"rename":XioPop.prompt({title:"Rename project",text:"Enter a new name for the project",value:c[g].name,onSubmit:function(a){if(a){var b=new FormData;b.append("new_name",a),b.append("project_id",g);var c=new XMLHttpRequest;c.open("POST","/scripts/rename_project.php",!0),c.onload=function(a){var b=a.target;200===b.status?(console.log("Project renamed"),findProjects()):console.err("Error renaming project",b)},c.send(b)}}});break;case"config":ProjectConfig.open(g);break;case"run":previewProject(g);break;default:setHash(g)}},t=function(a){for(var b=a.target;!b.classList.contains("project");){if(b===e)return;b=b.parentElement}u(),b.classList.add("selected")},u=function(){for(var a=e.getElementsByClassName("selected"),b=0;b<a.length;b++)a[b].classList.remove("selected")},v=function(b){if(b.which===KEY_ENTER){var c=e.querySelector(".selected");setHash(c.getAttribute("data-project_id")),b.preventDefault()}else b.which===KEY_DOWN?(w(),b.preventDefault()):b.which===KEY_UP?(w(!0),b.preventDefault()):a()},w=function(a){var b=e.querySelector(".selected");if(!b)return b=e.querySelector(".project"),u(),b.classList.add("selected"),!0;for(var c=a?b.previousElementSibling:b.nextElementSibling;null!==c;){if(!c.classList.contains("hidden"))return u(),c.classList.add("selected"),!0;c=a?c.previousElementSibling:c.nextElementSibling}return!1},x=function(a){switch(a.type){case"dragover":e.classList.add("dropzone"),a.preventDefault();break;case"dragleave":e.classList.remove("dropzone");break;case"drop":a.preventDefault(),e.classList.remove("dropzone");var b=a.dataTransfer.items;C(b)}},y=function(){XioPop.prompt({title:"Enter the project's name",onSubmit:function(a){if(a){var b=new XMLHttpRequest;b.open("get","/scripts/new_project.php?projectName="+a,!0),b.onload=function(a){200===a.target.status&&m()},b.send()}}})},z=function(a){return c&&c.hasOwnProperty(a)?c[a]:!1},A=function(){c=null,e.innerHTML=""},B=function(a){Ajax.post2JSON("/scripts/project_config.php?action=updateLastOpened",{project_id:a},function(b){b.status===STATUS_OK?c&&c.hasOwnProperty(a)&&(c[a].last_opened=b.last_opened):XioPop.alert({title:"Permission error",text:"Insuffient permission to update project last opened date in project config file."})})},C=function(a){function b(a){console.log("Answer:",a)}console.log("dropped items:",a);for(var c=[],d=0;d<a.length;d++){var e=a[d];switch(console.log("root item"+d,e.kind),e.kind){case"file":var f=e.webkitGetAsEntry();f&&c.push(f);break;default:console.warn("Drop does not handle items of type:",e.kind),console.debug(e)}}if(c.length>0){console.log("Vad vill du göra med dessa",c.length,"root items");var g=[{id:"OneProject",text:"Create one project including these items"},{id:"SplitProjects",text:"Split up into "+c.length+" separate projects"}];XioPop.choose({title:"Drop action",text:c.length+" items was dropped, what do you want to do with them?",options:g,onSubmit:b})}};return{clear:A,setOrderBy:o,getProject:z,loadProjects:m,updateLastOpened:B}}();!function(){var a,b=document.getElementById("tplCodeEditorTab").content,c=self.Tab=function(c,d){this.parent=c,this.file=d,this.file.tab=this;var e=b.querySelector("li");e.dataset.id=d.id,a=b.querySelector(".filename"),this.updateFromFile();var f=document.importNode(b,!0);this.parent.tabList.appendChild(f),this.elem=this.parent.tabList.querySelector("li[data-id='"+d.id+"']"),this.elem.addEventListener("click",this.clickHandler.bind(this),!1),a=this.elem.querySelector(".filename"),this.updateState()};c.prototype={remove:function(){this.parent.tabList.removeChild(this.elem)},select:function(){this.elem.classList.add("selected")},deselect:function(){this.elem.classList.remove("selected")},updateFromFile:function(){a.textContent=this.file.filename,a.title=this.file.uri},updateState:function(){var a=this.elem.classList;switch(a.remove("loading"),
a.remove("saving"),this.file.doc.isClean()?a.remove("changed"):a.add("changed"),console.log("file state",this.file.state),this.file.state){case File.STATE_LOADING:this.elem.classList.add("loading");break;case File.STATE_READY:break;case File.STATE_SAVING:a.add("saving")}},clickHandler:function(a){return console.log("tabClick",a),"svg"===a.target.nodeName||"use"===a.target.nodeName||2===a.which?void this.file.close():void this.parent.codeEditor.switchToFile(this.file)}}}(),TabBar.prototype.select=function(a){for(var b=0;b<this.tabs.length;b++){var c=this.tabs[b];c===a?c.select():c.deselect()}},TabBar.prototype.add=function(a){var b=new Tab(this,a);this.tabs.push(b),a.setTab(b)},TabBar.prototype.remove=function(a){for(var b=0;b<this.tabs.length;b++)this.tabs[b]===a&&this.tabs.splice(b,1);a.remove()},TabBar.prototype.clear=function(){this.tabList.innerHTML="",this.tabs.length=0};var Todo=function(){var a,b,c,d,e,f,g,h,i,j,k=function(){a=document.getElementById("btnAddFeature"),a.addEventListener("click",q,!1),b=document.getElementById("btnAddBug"),b.addEventListener("click",r,!1),c=document.getElementById("listTodos"),c.addEventListener("click",l,!1),c.addEventListener("dragover",m,!1),c.addEventListener("dragenter",m,!1),c.addEventListener("dragleave",m,!1),c.addEventListener("dragstart",m,!1),c.addEventListener("dragend",m,!1),d=document.getElementById("listTodosDone"),d.addEventListener("click",l,!1)},l=function(a){if("click"===a.type){for(var b=a.target;"LI"!==b.nodeName;){if(b===c)return;b=b.parentElement}var d=b.dataset.id,e=i[d];console.log("clicked on",d),s({todoId:d,type:e.type,status:e.status,created:e.created,edited:e.edited,title:"Edit "+e.type+": "+d,description:e.description})}},m=function(a){if("dragenter"===a.type||"dragleave"===a.type)for(var b=a.target;"LI"!==b.nodeName;){if(b===c)return;b=b.parentElement}switch(a.type){case"dragenter":a.preventDefault(),c.insertBefore(e,f?b:b.nextSibling);break;case"dragstart":e=a.target,e.classList.add("dragged"),c.classList.add("reordered");var d=document.createElement("img");d.src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",a.dataTransfer.setDragImage(d,-10,-10);break;case"dragend":c.classList.remove("reordered"),a.target.classList.remove("dragged");for(var i=c.children,j=[],k=0;k<i.length;k++)j.push(i[k].dataset.id);var l=new FormData;l.append("project_id",h),l.append("prio",j),Ajax.post2JSON("/scripts/todo_handler.php",l,n);break;case"dragleave":a.preventDefault();break;case"dragover":a.preventDefault(),g!==a.pageY&&(f=g>a.pageY),g=a.pageY}},n=function(a){console.log("prio",a)},o=function(a){h=a,x(),Ajax.getJSON("/scripts/todo_handler.php",{project_id:h,action:"getAll"},function(a){i=a.todos,XI.fire("todosLoaded")})},p=function(){c.innerHTML="",d.innerHTML="";var a=Object.keys(i).sort(function(a,b){return i[a].prio-i[b].prio});for(var b in a){var e=a[b],f=i[e],g="done"===f.status;f.type||(f.type="feature");var h=document.createElement("LI");h.classList.add(f.type),h.dataset.id=e,g||(h.draggable="true");var j=document.createElement("span");j.textContent=f.description,j.classList.add("title"),h.appendChild(j),g?d.appendChild(h):c.appendChild(h)}},q=function(a){s({type:"feature",title:"Add a new feature"})},r=function(a){s({type:"bug",title:"Add a new bug report"})},s=function(a){var b=(!!a.todoId,document.getElementById("tplTodoEdit").content),c=b.querySelector("input[name=todo_id]");c.value=a.todoId||"";var d=b.querySelector("#todoTimeCreated");a.created&&(d.textContent=toHumanReadableDateTime(parseInt(a.created)));var e=b.querySelector("#todoTimeEdited");a.edited&&(e.textContent=toHumanReadableDateTime(parseInt(a.edited)));var f=b.querySelector("textarea");f.textContent=a.description||"";var g=b.querySelector("h3");g.textContent=a.title;var h=b.querySelector("input[name=type][value="+a.type+"]");h.checked="checked",a.status||(a.status="new");var i=b.querySelector("input[name=status][value="+a.status+"]");i.checked="checked",j=XioPop.showElement({element:document.importNode(b,!0)});var k=document.getElementById("formTodo");k.addEventListener("submit",t,!1);var l=k.querySelector("button.delete");l.dataset.todoId=a.todoId,l.addEventListener("click",v,!1),f.focus()},t=function(a){a.preventDefault();var b=new FormData(a.target);b.append("project_id",h),b.append("ts",(new Date).getTime()),Ajax.post2JSON("/scripts/todo_handler.php",b,u),y()},u=function(a){switch(a.status){case STATUS_OK:console.log("submit callback",a),i[a.todo_id]=a.todo,p();break;case STATUS_FILE_COULD_NOT_UPDATE:XioPop.alert({title:"Permission denied",text:"You do not have sufficient permission to update project todo file"});break;default:XioPop.alert({title:"Error",text:"Unknown error while saving todo config"})}},v=function(a){var b=new FormData;b.append("project_id",h),b.append("todo_id",a.target.dataset.todoId),Ajax.post2JSON("/scripts/todo_handler.php?action=delete",b,w),y()},w=function(a){console.log("delete callback",a),delete i[a.todo_id],p()},x=function(){c.innerHTML="",d.innerHTML="",i={}},y=function(){j&&(j.close(),j=null)};return XI.listen("DOMContentLoaded",k),XI.listen(["DOMContentLoaded","todosLoaded"],p,!0),{loadAll:o,clear:x}}(),XioCode=function(){var a=10,b=null,c=null,d=!1,e={},f=function(){d||(e=[{name:"CodeEditor1",type:a,codeEditor:new CodeEditor(document.getElementById("paneEditor1"))}],c=e[0].codeEditor,d=!0)},g=function(){return b},h=function(){return e},i=function(){return c},j=function(a){c=a},k=function(a){b=a,f()};return{getActiveProjectId:g,getActiveCodeEditor:i,setActiveCodeEditor:j,openProject:k,getPanes:h}}();!function(){function a(a){var b=a.target;if(b!==this.toolList){for(;b.parentElement!==this.toolList;)b=b.parentElement;var c=b.dataset.action;switch(c){case"save":this.saveFile();break;case"preview":previewFile(this.activeFile.uri);break;default:console.warn("toolbar action not implemented:",c)}}}function b(a,b){a.setCursor(a.coordsChar({left:b.x,top:b.y})),a.focus()}function c(a,b){var c=b.dataTransfer.getData("uri");if(c){var d=c;switch(!0){case null!==c.match(/css$/):d='<link rel="stylesheet" href="'+c+'" type="text/css" />';break;case null!==c.match(/js$/):d='<script src="'+c+'"></script>';break;case null!==c.match(/php$/):d='require "'+c+'";'}console.log("Drop on cm",c),a.replaceSelection(d),b.preventDefault()}}function d(a,b){this.activeFile&&this.updateFileStatus(this.activeFile)}function e(a,b){XioCode.setActiveCodeEditor(this)}var f=self.CodeEditor=function(f){this.elem=f,this.activeFile=null,this.activeProjectId=null;var g=document.getElementById("tplCodeEditorHeader").content;f.appendChild(document.importNode(g,!0)),this.tabList=f.querySelector(".tabBar"),this.tabBar=new TabBar(this.tabList,this),this.toolList=f.querySelector(".toolbar"),this.toolList.addEventListener("click",a.bind(this),!1),this.btnSave=this.toolList.querySelector("li[data-action='save']"),this.btnPreview=this.toolList.querySelector("li[data-action='preview']"),this.btnNew=this.toolList.querySelector("li[data-action='new']"),this.editor=new CodeMirror(f,clone(codemirrorDefaults)),this.editor.on("dragover",b.bind(this)),this.editor.on("drop",c.bind(this)),this.editor.on("change",d.bind(this)),this.editor.on("focus",e.bind(this))};f.prototype={updateFileStatus:function(a){var b=a.state!==File.STATE_UNSAVED,c=a.doc.isClean()&&b;a.state===File.STATE_LOADING||a.state===File.STATE_SAVING;c?FileList.setFileAsClean(a.uri):FileList.setFileAsDirty(a.uri),a.tab.updateState(),a===this.activeFile&&(b?this.btnPreview.classList.remove("disabled"):this.btnPreview.classList.add("disabled"),c?this.btnSave.classList.add("disabled"):this.btnSave.classList.remove("disabled"))},setProjectId:function(a){if(this.activeProjectId!==a){this.activeProjectId=a,this.clear();var b=File.getProjectFiles(a),c=Object.keys(b).length;if(c>0){var d=null;for(var e in b)if(b.hasOwnProperty(e)){var f=b[e];this.tabBar.add(f),d||(d=f)}d&&this.switchToFile(f)}else console.log("Project has no files opened, HIDE!"),this.btnSave.classList.add("disabled"),this.btnPreview.classList.add("disabled"),this.editor.setOption("readOnly",!0)}},clear:function(){var a=CodeMirror.Doc("");this.editor.swapDoc(a),this.tabBar.clear(),this.activeFile=null},saveFile:function(){var a=this.activeFile;a&&(a.state===File.STATE_UNSAVED||a.state===File.STATE_EMPTY?this.saveFileAs(a,!1):(this.editor.execCommand("removeTrailingSpaces"),a.save(this.editor.getValue(),this.saveFileCallback.bind(this)),this.updateFileStatus(a)))},saveFileCallback:function(a){this.updateFileStatus(a),Preview.doRefreshOnSave()&&(Preview.load(projectsURL+this.activeProjectId+"/"+a.uri),Preview.refresh())},saveFileAs:function(a,b){console.log("Save As... ");var c=this;a.projectId=this.activeProjectId,XioPop.prompt({title:"Save file as...",text:"Enter the filename",value:a.uri,onSubmit:function(b){b&&(c.editor.execCommand("removeTrailingSpaces"),a.saveAs(b,c.editor.getValue(),!1,c.saveFileAsCallback.bind(c)),c.updateFileStatus(a))}})},saveFileAsCallback:function(a,b){switch(b.status){case STATUS_OK:console.log("file saved as ",a.uri),FileList.loadProjectFiles(),this.updateFileStatus(a),a.tab.updateFromFile(),this.calculateFileMode(a.uri);break;case STATUS_FILE_COLLISION:var c=this;XioPop.confirm({title:"File already exists",text:"Are you sure you want to overwrite "+b.uri+"?",onSubmit:function(d){d&&(a.saveAs(b.uri,c.editor.getValue(),!0,c.saveFileAsCallback.bind(c)),c.updateFileStatus(a))}});break;default:console.warn("handle callback",b)}},calculateFileMode:function(a){if(a){var b=getMimeByUri(a);this.editor.setOption("mode",b)}},newFile:function(){var a=new File(this);a.blank(this.activeProjectId),this.tabBar.add(a),this.switchToFile(a),this.editor.setOption("readOnly",!1)},switchToFile:function(a){this.editor.swapDoc(a.doc),this.activeFile=a,this.tabBar.select(a.tab),this.updateFileStatus(a),this.editor.focus()},switchToNext:function(){var a=this.tabList.children;console.log("active tab",this.activeFile.tab);for(var b=null,c=0;c<a.length;c++){var d=a[c],e=parseInt(d.dataset.id);if(e===this.activeFile.id){null===b&&(console.log("next",a[c+1],a[c]),b=parseInt(a[c+1].dataset.id));break}b=e}var f=File.getFileById(b);this.switchToFile(f)},openFile:function(a){var b=File.getFileByUri(this.activeProjectId,a);b?this.editor.setOption("readOnly",!1):(b=new File(this),b.load(this.activeProjectId,a,this.openFileCallback.bind(this)),this.tabBar.add(b)),this.switchToFile(b)},openFileCallback:function(a){if(this.activeFile===a){this.editor.swapDoc(a.doc);this.editor.setOption("readOnly",!1),console.log("File opened with mode ",a.doc.modeOption)}this.updateFileStatus(a)},closeFile:function(a){this.tabBar.remove(a.tab),this.activeFile===a?(console.log("close active file",a),0===this.tabList.children.length?(console.log("last file closed, HIDE!!!"),this.btnSave.classList.add("disabled"),this.btnPreview.classList.add("disabled"),this.clear(),this.editor.setOption("readOnly",!0)):this.switchToNext()):console.log("close file",a),this.editor.focus()}}}();var codemirrorSnippets={html:'<!doctype html>\n<html>\n	<head>\n		<title>Page Title</title>\n		<meta charset="utf-8" />\n		<link rel="stylesheet" href="style.css" type="text/css" />\n	</head>\n	<body>\n		\n	</body>\n</html>',css:'<link rel="stylesheet" href="style.css" type="text/css" />',mobile:'<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />',com:"/**********************************************************\n\n\n**********************************************************/",phperror:"ini_set('display_errors',1);\nini_set('error_reporting', E_ALL ^ E_NOTICE);",xhr:"xhr = new XMLHttpRequest();",favicon:'<link rel="shortcut icon" href="favicon.ico" />'},codemirrorDefaults={lineNumbers:!0,matchBrackets:!0,autoCloseTags:!0,autoCloseBrackets:!0,autoClearEmptyLines:!0,styleActiveLine:!0,indentUnit:4,indentWithTabs:!0,colorpicker:!0,smartIndent:!0,theme:"xio",highlightSelectionMatches:{showToken:/\w/},extraKeys:{Tab:"tabWithAutoComplete","Shift-Tab":"indentLess","Ctrl-D":"removeLines","Cmd-D":"removeLines","Ctrl-N":"newFile","Cmd-N":"newFile","Ctrl-S":"shortcutSave","Cmd-S":"shortcutSave","Alt-Up":"swapLineUp","Alt-Down":"swapLineDown","Ctrl-Alt-Down":"duplicateRowDown","Cmd-Alt-Down":"duplicateRowDown","Ctrl-Alt-Up":"duplicateRowUp","Cmd-Alt-Up":"duplicateRowUp","Cmd-I":"selectLines","Ctrl-I":"selectLines","Cmd-L":"jump2Line","Ctrl-L":"jump2Line","Cmd-O":"showAllFunctions","Ctrl-O":"showAllFunctions","Ctrl-Q":"toggleComment","Cmd-Q":"toggleComment","Ctrl-B":"removeTrailingSpaces"}};CodeMirror.commands.duplicateRowUp=function(a){CodeMirror.commands.duplicateRow(a,!0)},CodeMirror.commands.duplicateRowDown=function(a){CodeMirror.commands.duplicateRow(a,!1)},CodeMirror.commands.duplicateRow=function(a,b){var c=a.getCursor("start"),d=a.getCursor("end"),e=a.getRange({line:c.line,ch:0},{line:d.line});b?d.line===a.doc.lastLine()?(a.replaceRange("\n"+e,{line:d.line}),a.setSelection(c,d)):a.replaceRange(e+"\n",{line:d.line+1,ch:0}):0===c.line?a.replaceRange(e+"\n",{line:0,ch:0}):a.replaceRange("\n"+e,{line:c.line-1})},CodeMirror.commands.removeLines=function(a){var b=a.getCursor("start").line,c=a.getCursor("end").line,d=a.getCursor();a.replaceRange("",{line:b,ch:0},{line:c+1,ch:0}),a.setCursor(d)},CodeMirror.commands.selectLines=function(a){var b=a.getCursor("start"),c=a.getCursor("end");b.ch=0,c.ch=a.getLine(c.line).length,a.setSelection(b,c)},CodeMirror.commands.tabWithAutoComplete=function(a){console.log("tabWithAutoComplete");var b=a.getCursor(),c=a.getSearchCursor(/\s/),d=c.matches(!0,b);console.log("match",d);var e;e=d?d.to:{line:b.line,ch:0};var f=a.getRange(e,b).trim();codemirrorSnippets[f]?a.replaceRange(codemirrorSnippets[f],e,b):a.execCommand(a.getSelection().length?"indentMore":"insertTab")},CodeMirror.commands.shortcutSave=function(a){console.log("Ctrl/Cmd+s pressed",a),XioCode.getActiveCodeEditor().saveFile()},CodeMirror.commands.newFile=function(a){console.log("Ctrl/Cmd+n pressed, new file..."),unloadFile()},CodeMirror.commands.jump2Line=function(a,b){return void 0===b?void XioPop.prompt({title:"Jump to line",text:"Enter the desired line number",onSubmit:function(b){Number(b)>0&&CodeMirror.commands.jump2Line(a,Number(b)-1)}}):(a.setCursor(b+100,0),a.setCursor(b-10,0),a.setCursor(b,0),void a.focus())},CodeMirror.commands.removeTrailingSpaces=function(a){a.doc.eachLine(function(a){a.text=a.text.replace(/\s+$/,"")}),a.refresh()},CodeMirror.commands.showAllFunctions=function(a){var b=findFunctions();console.log(b),XioPop.select({options:b,onSubmit:function(b){console.log("selected function",b),CodeMirror.commands.jump2Line(a,b.line)}})};
//# sourceMappingURL=xiocode.min.js.map